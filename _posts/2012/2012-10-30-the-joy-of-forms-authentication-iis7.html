---
layout: post
title: The Joy of Forms Authentication, IIS7 and Device Profiles
date: '2012-10-30T20:08:00.001Z'
author: Dylan Beattie
tags: 
modified_time: '2012-10-30T20:15:09.022Z'
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-2355877210257021047
blogger_orig_url: http://www.dylanbeattie.net/2012/10/the-joy-of-forms-authentication-iis7.html
redirect_from: "/2012/10/the-joy-of-forms-authentication-iis7.html"

---

<p>We’re setting up a thing called <a href="http://www.paessler.com/prtg">PRTG Network Monitor</a> to add monitoring and logging to one of our new MVC3 web applications, and I spent this morning scratching my head and wondering why an app that works just fine when you view it in a browser was consistently failing when I tried to attach an HTTP monitor to it.</p>  <p>A little digging with <a href="http://www.wireshark.org/">Wireshark</a> later, and it turns out that IIS/ASP.NET isn’t sending the FormsAuthentication cookie in the response to requests made via the PRTG monitoring software. Which is… odd. We haven’t explicitly configured cookieless authentication or anything – although we’re doing some funky stuff with cross-domain auth cookies, the PRTG monitor is as simple as it gets – POST credentials to the login handler, get a response, check the response includes a cookie. Not rocket surgery.</p>  <p>After a fun hour of comparing TCP traces and HTTP headers, it turns out it’s the <a href="http://en.wikipedia.org/wiki/User_agent">HTTP User Agent</a> that’s controlling this behaviour – if ASP.NET running under IIS7 sees particular user agents, it just doesn’t set any cookies. And this is where it gets interesting. Here’s some real-world HTTP user agents that work just fine:</p>  <blockquote>   <p><font size="2"><strong>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1</strong></font></p>    <p><font size="2"><strong>Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0);</strong></font></p>    <p><font size="2"><strong>Opera/9.80 (Windows NT 6.1; WOW64; U; en) Presto/2.10.289 Version/12.02</strong></font></p> </blockquote>  <p>Here’s the PRTG monitoring software’s default user agent. Now this looks to me like a completely sensible user agent for a piece of monitoring software – but IIS7 clearly believes this to be a client that can’t handle HTTP cookies, and so won’t set any:</p>  <blockquote>   <p><font size="2"><strong>Mozilla/5.0 (compatible; PRTG Network Monitor (www.paessler.com); Windows)</strong></font></p> </blockquote>  <p>But the <em>really</em> fun part – here’s a bunch of user agents that work absolutely fine:</p>  <blockquote>   <p><strong>Bozilla/5.0 (compatible; PRTG Network Monitor (www.paessler.com); Windows)</strong></p>    <p><strong>Batman/1.2 (compatible; spiderman; vigorous jazz-hands)</strong></p>    <p><strong>CAKE CAKE CAKE CAKE CAKE I LIKE CAKE</strong></p>    <p><strong>CookieHater1.2 (incompatible; does not accept cookies; no cookies; cookies are evil)</strong></p> </blockquote>  <p>This doesn’t work:</p>  <blockquote>   <p><strong>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML)</strong></p> </blockquote>  <p>But these do:</p>  <blockquote>   <p><strong>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like a BOSS)</strong></p>    <p><strong>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like anyone cares)</strong></p> </blockquote>  <p>In short - it looks like any string that starts with “Mozilla” triggers some sort of complicated parsing algorithm that looks for magic values in the user-agent string and decides that means they’re cookie-capable. I have this horrible, horrible feeling that somewhere in the bowels of the IIS team there’s somebody who still thinks <a href="https://browsers.garykeith.com/">browscap.ini</a> was a good idea – and I’m <em>amazed </em>that something as fragile and idiosyncratic as determining device capabilities based on user agents would be the default behaviour in IIS7 and ASP.NET 4.</p>  <p>The good news is that this bizarre behaviour is easily fixed – just add <strong>cookieless=&quot;useCookies&quot;</strong> to the <strong>system.web/authentication/forms </strong>element of your web.config file. The default is apparently “useDeviceProfile”, and there’s more details in the <a href="http://technet.microsoft.com/en-us/library/cc732830(v=ws.10).aspx">IIS documentation on Microsoft Technet</a>.</p>  <p>This is also another classic example of how easily you can lose an entire day of developer time to something that <em>should </em>have taken about ten minutes. We have an app that uses HTTP and out-of-the-box cookie-based authentication. We’ve got something approaching 500 tests verifying the behaviour of this app under every scenario we could think of. We have a mature, stable monitoring platform that hundreds, if not thousands, of people are using to monitor HTTP applications every day. And yet BANG! you connect them together, everything falls apart and next thing you know you’re up to your elbows in network packets and wondering if it’s too early in the week to start drinking…</p>  <p><strong>UPDATE:</strong> Thanks to <a href="http://twitter.com/duncansmart">@duncansmart</a> for pointing me at <a href="http://www.hanselman.com/blog/FormsAuthenticationOnASPNETSitesWithTheGoogleChromeBrowserOnIOS.aspx">this article on Scott Hanselman’s blog</a> where he discusses this very problem. </p>  