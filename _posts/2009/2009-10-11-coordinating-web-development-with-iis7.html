---
layout: post
title: Coordinating Web Development with IIS7, DNS and the Web Deployment Tool
date: '2009-10-11T22:59:00.000+01:00'
author: Dylan Beattie
tags:
- howto
- coding
- iis
- classic-asp
modified_time: '2009-10-11T22:57:06.176+01:00'
thumbnail: http://lh4.ggpht.com/_LV_l8kYLOwo/StJUlRaYqvI/AAAAAAAAAP0/r7OOM-PIKJA/s72-c/IMG_6835_thumb%5B6%5D.jpg?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-8834526336258210155
blogger_orig_url: http://www.dylanbeattie.net/2009/10/coordinating-web-development-with-iis7.html
---

<blockquote>   <p>DISCLAIMER: There’s some stuff in here which could cause all sorts of chaos if it doesn’t sit happily alongside your individual setup – in particular, hacking your internal DNS records is a really bad idea unless you know what’s already in there, and you understand how DNS resolution works within your organisation. Be careful, and if you’re not responsible for your DNS setup, probably best to discuss this with whoever <em>is</em> responsible for it first.</p> </blockquote>  <p>I’ve been setting up a continuous integration system for our main software products. We host 20+ web sites and applications across four different domain names, ranging from ancient legacy ASP applications based on VBScript and recordsets, to ASP.NET MVC apps built with TDD, Windsor, NHibernate and “alt-net” stack.</p>  <p><a href="http://lh6.ggpht.com/_LV_l8kYLOwo/StJUk5K0laI/AAAAAAAAAPw/gzGr1vnpeT4/s1600-h/IMG_6835%5B8%5D.jpg"><img style="border-bottom: 0px; border-left: 0px; margin: 0px 0px 20px 20px; display: inline; border-top: 0px; border-right: 0px" title="The City of London skyline, from the South Bank at low tide." border="0" alt="The City of London skyline, from the South Bank at low tide." align="right" src="http://lh4.ggpht.com/_LV_l8kYLOwo/StJUlRaYqvI/AAAAAAAAAP0/r7OOM-PIKJA/IMG_6835_thumb%5B6%5D.jpg?imgmax=800" width="182" height="242" /></a>Here’s a couple of things we’ve come up with that make the whole process run a little more smoothly. Let’s imagine our developers are Alice, Bob and myself, and we’re running a three-stage deployment process. Here’s how it works.</p>  <ol>   <li>Alice implements a new feature, working on code on her local workstation. She has a full local copy of every site, under Subversion control, which she can view and test at <a href="http://www.website.com.local">www.website.com.local</a> </li>    <li>Once the feature’s done, Alice commits her code. TeamCity – the continuous integration server – will pull the change from Subversion, build it, and deploy the results to <a href="http://www.website.com.build">www.website.com.build</a> </li>    <li>We run tests – both automated and manual – against this build site. If everything looks OK, we send this .build URL to the stakeholders and testers to get their feedback on the new feature. </li>    <li>Once the tests are green and the stakeholders are happy, the feature is ready for launch. We’ll now use msdeploy to push the <strong>entire modified website</strong> onto the test server - <a href="http://www.website.com.test">www.website.com.test</a> </li>    <li>We run integration tests that hit&#160; <a href="http://www.website.com.test">www.website.com.test</a> – and also <a href="http://www.website.com.test/some_app">www.website.com.test/some_app</a>, <a href="http://www.website2.co.uk.test">www.website2.co.uk.test</a>, <a href="http://www.another-site.com.test">www.another-site.com.test</a> – basically, they verify that not only do the individual apps and sites all work, but that they’re co-existing happily on the same server. </li>    <li>Finally, we have a couple of msdeploy tasks set up in TeamCity, that will deploy the <strong>entire server configuration</strong> from the test server to the public-facing servers. </li> </ol>  <h3>Setting up Developer Workstations</h3>  <p>Most of our developer machines are running Windows 7, which includes IIS7, which supports multiple websites (this used to be a huge limitation of XP Professional, which would only run a single local website). We have a standard setup across workstations, build, test and live servers – they all have a 100Gb+ D: drive dedicated for web hosting, which means we can use msdeploy.exe to clone the test server onto new workstations (or just to reset your own configuration if things get messed up), and to handle the deployment from build to test to live.</p>  <p>Note that this <strong>doesn’t</strong> mean we’re hard-coding paths to D:\ drives – the apps and sites will happily run from any location on the server, since they use virtual directories and Server.MapPath() to handle any filesystem access. However, it does make life much easier to set up configuration once, and then clone this config across the various systems.</p>  <p>Finally, note that our workstations are 64-bit and the servers are 32-bit, which works fine with one caveat – you can sync and deploy configuration <strong>from</strong> the servers <strong>to </strong>the workstations, but not vice versa. In practise, this is actually quite useful – anything being pushed onto the servers should be getting there via Subversion and TeamCity anyway </p>  <h3>Using DNS to manage .local, .build and .test zones</h3>  <p>Unless you want to maintain a <em>lot </em>of /etc/hosts files, you’ll need your own local DNS servers for this part – but if your organisation is using Active Directory, you’re sorted because your domain controllers are all local DNS servers anyway. The trick here is to create “fake” locally-accessible DNS zones containing wildcard records. We have a zone called <strong>local</strong>, which contains a single DNS CNAME record that points&#160; <strong>*</strong> at 127.0.0.1. This means that anything.you.like.local will resolve to 127.0.0.1 – so developers can access their local copies of every site by using something like <a href="http://www.sitename.com.local">www.sitename.com.local</a>. </p>  <p>There’s a DNS zone called <strong>build</strong>, which contains an ALIAS record pointing * at build-server.mydomain.com, and another one called test, which has an ALIAS record pointing * at test-server.mydomain.com. We’ve also set up *.dylan as an alias for my workstation, and *.alice as an alias for Alice’s PC, and *.bob as an alias for Bob’s PC, and so on. </p>  <p>This seems simple but it’ll actually give you some very neat capabilities:</p>  <ul>   <li>Every developer can see their own projects at <a href="http://www.website.com.local">www.website.com.local</a> and <a href="http://www.othersite.co.uk.local">www.othersite.co.uk.local</a>&#160; </li>    <li>Everyone in the organization can see a particular developer’s work in progress, by going to <a href="http://www.website.com.alice">www.website.com.alice</a> or <a href="http://www.othersite.co.uk.bob">www.othersite.co.uk.bob</a> </li>    <li>Everyone in the organization can see the build server – <a href="http://www.website.com.build">www.website.com.build</a> – and the test server, <a href="http://www.website.com.test">www.website.com.test</a> </li> </ul>  <p>Of course, this doesn’t work unless there’s a web server on the other end that’s listening for those requests, so our common IIS configuration has the following bindings set up for every site:</p>  <p><a href="http://lh5.ggpht.com/_LV_l8kYLOwo/Ss7-GPdCStI/AAAAAAAAAPo/oKpIFCgrGD4/s1600-h/image3.png"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_LV_l8kYLOwo/Ss7-Gku_gHI/AAAAAAAAAPs/MFVElgEPATA/image_thumb1.png?imgmax=800" width="607" height="306" /></a> </p>  <p>This looks like a lot of work to maintain, but because developer workstations are set up by using msdeploy to clone the test server’s configuration, these mappings only need to be created once, manually, on the test server, and they’ll be transferred across along with everything else.</p>  <p>I’d be interested to hear from anyone who’s using a similar setup – or who’s found an alternative approach to the same problem. Leave a comment here or drop me a line – or better still, blog your own set-up and send me a link, and I’ll add it here.</p>  