---
layout: post
title: The Story of the Lazy-Loading Lunchbox
date: '2009-01-14T01:03:00.002Z'
author: Dylan Beattie
tags:
- dotnet
- altnet
- c#
- random
- musings
modified_time: '2017-03-18T15:03:45.148Z'
thumbnail: http://lh3.ggpht.com/_LV_l8kYLOwo/SW059PCNOVI/AAAAAAAAAIQ/utQ0W8lHoS0/s72-c/baby_dylan_thumb%5B2%5D.jpg?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-2643935106694292239
blogger_orig_url: http://www.dylanbeattie.net/2009/01/story-of-lazy-loading-lunchbox.html
---

<p><a href="http://lh3.ggpht.com/_LV_l8kYLOwo/SW058_8qNcI/AAAAAAAAAIM/GZW7y6k6tdM/s1600-h/baby_dylan%5B4%5D.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; margin: 0px 0px 10px 10px; border-right-width: 0px" height="240" alt="This is me just after I got my Amstrad 6128" src="http://lh3.ggpht.com/_LV_l8kYLOwo/SW059PCNOVI/AAAAAAAAAIQ/utQ0W8lHoS0/baby_dylan_thumb%5B2%5D.jpg?imgmax=800" width="178" align="right" border="0" /></a> Many years ago when I was a lot smaller and still thought <strong>20 GOTO 10 </strong>was pretty cool, my long-suffering mother would pack me off to school every day, with a lovingly-packed rucksack containing my homework, gym kit, packed lunch, pencil case and various other educational essentials. At lunchtime, all the packed-lunch kids would go outside and play at being spies and Thundercats until the sandwich-bell rang, which meant it was time to go inside and eat. We'd all troop into the dinner-hall and get out our plastic MASK and He-Man lunchboxes and unwrap our squashed-looking sandwiches and warm bananas and little plastic Thermos flasks of Ribena. Ham sandwiches, jam sandwiches, or - for special occasions - ham <strong>and</strong> jam, all the better for spending three hours in a warm airtight plastic box alongside a banana.  </p>  <p>Once in a while, something would liven up the lunch break. I'll never forget what happened when Jeremy's parents went on holiday and left the babysitter in charge. Next day, Jeremy opened his lunchbox and instead of sandwiches, there was a pizza menu, and a £10 note in there. He had to ask for special permission to use the phone in the office... good thing Chris had an older sister who worked at Speedy Pizza otherwise I don't think they'd have believed us. Next day the headmistress shouted at everyone in assembly,  and there were letters sent home to parents. (My dad laughed about it all weekend.)</p>  <p><a href="http://lh6.ggpht.com/_LV_l8kYLOwo/SW059pPiZWI/AAAAAAAAAIU/7G5zSEZ6reM/s1600-h/lunchboxheman%5B7%5D.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; margin: 10px 20px 10px 0px; border-right-width: 0px" height="158" alt="He-Man Lunchbox from www.retrojunk.com" src="http://lh3.ggpht.com/_LV_l8kYLOwo/SW05-PCNiVI/AAAAAAAAAIY/VgMw_FmIWJw/lunchboxheman_thumb%5B5%5D.jpg?imgmax=800" width="240" align="left" border="0" /></a>Then Jim joined our class. I happened to be <strong>lunch monitor </strong>on his first day, which meant I got to hand out all the lunchboxes when the sandwich bell rang. As I lined them up to hand out, I realized that Jim's was <em>empty</em>.  Light as a feather, no noise when you shook it - clearly there was nothing inside. Poor kid, I thought, forgetting his packed lunch on his very first day! I figured I could give him half of my sandwich, and if Chris had bacon crisps he'd probably give them to Jim 'cos Chris hated bacon crisps... it was OK, I told myself. We'd work something out.</p>  <p>Then Jim sat down with his empty lunchbox... and before we knew it, he was tucking into a full three-course roast lunch, piping hot - with gravy, and a glass of milk, and <em>ice-cream for afters</em>. We sat around with envious eyes, eating our banana-scented ham sandwiches, aware that something funny was clearly going on (<em>"why doesn't it melt?"</em>) Next day - same thing. On Fridays, he'd get roast pork and dumplings (his favourite, apparently). We asked Jim one day how he did this, but he didn't know. "My mum always does my lunchbox", he said, between mouthfuls of potatoes and gravy, and so the mystery went on. Finally, just before the end of term, Jim asked if I wanted to go over and play after school one afternoon.  I jumped at the chance - finally, I could ask his mum about those amazing packed lunches.</p>  <p>The long-awaited day came, and after Jim and I were all done playing <a title="Ghostbusters wins? That's not how *I* remember it..." href="http://tweetfu.com/fights/81-thundercats-ghostbusters">Thundercats vs. Ghostbusters</a> in the garden, Jim's mum called us in for tea. We sat around their big dining table and we ate raspberry jelly and ice-cream, and eventually I plucked up the courage to ask about the lunches.</p>  <p>"Mrs. Fowler", I said politely (for that was her name), "me'n'the other children were wondering about Jim's packed lunch, please... how come the ice-cream doesn't melt from being next to the roast potatoes all day? An' how does Jim get all that food into such a tiny box?"</p>  <p>"Oh, that's easy", she said. "See, we bought Jim a <strong>lazy-loaded lunchbox</strong>.  He's a growing lad, and he needs plenty to eat, but I think carrying all that food around all day would give him a bad back. Besides, most days he's off out the door before I've even put the potatoes in the oven - and if he kept turning up late because I didn't have his packed lunch ready for him, I'm sure his teacher would complain. So I get his lunch ready for him and keep it warm in the oven, and then when it's time to eat it, I just pop it into his lunchbox - easy peasy! Now, who'd like more ice-cream?"</p>  <p>I went home even more confused than when I arrived. She must be winding me up, I thought - that's <em>impossible - </em>but Jim's amazing lunches just kept on going. One by one, we all tried to get OUR mothers to do us roast-beef-and-ice-cream packed lunches, but it never worked - from the day Pete's bag dripped gravy and raspberry ripple all over the nature corner, to the day Rob's mum got in trouble for trying to break into the school kitchen, none of us ever got a three-course roast packed lunch except Jim. </p>  <h2>Hang on... you're making this up!</h2>  <p>OK, ok, busted. It's not a true story. Except the bit about Thundercats. And Chris getting gravy in the nature corner, come to think of it. But there's a couple of details in here that might help explain a few things if you're trying to get your head round OO architecture and enterprise design patterns.</p>  <h3>Separation of Concerns - aka "Why is a Eight-Year-Old Ordering Pizza?"</h3>  <p>The various parts of an object-oriented application should have their own distinct responsibilities, and should depend on each other for help when they need to do something outside their immediate remit. Web pages shouldn't send e-mail. Database queries shouldn't return HTML. When objects end up doing things they're not supposed to, that's a warning sign - <strong>just like an eight-year-old ordering a pizza</strong>.</p>  <p>If you're relying on a eight-year-old to arrange their own lunch, you're not separating your concerns properly. To make lunch, we need to go shopping, handle money - and get the Penguin bars from their secret hiding place on top of the fridge. Kids don't know where the food <em>comes</em> from - and they shouldn't have to; if they were in charge of this, it would lead to all sorts of chaos.</p>  <p>Kids have clearly defined responsibilities. They torment the guinea pig, throw up during maths, eat lunch, play Thundercats, have nap time and go home. They shouldn't be shopping, they shouldn't be cooking, and they get <em>really </em>funny looks if they tell the teacher they're just popping out for falafel and a skinny latté. (Incidentally, the the teachers, Mr. Namespace and Mrs. Interface, understand all this, and the reason they don't let kids go out for falafel is that they're enforcing this separation of concerns.)</p>  <h3>Aggregates and Repositories - aka "Mum, Did You Pack My Gym Kit?"</h3>  <p>That rucksack that my mum would pack for me before sending me off for a day in the big wide world was an <strong>aggregate </strong>- a top-level container, containing a whole collection of objects that make sense when you put them inside each other, as in the following example:</p>  <p> <a href="http://lh4.ggpht.com/_LV_l8kYLOwo/SW05-uUkIVI/AAAAAAAAAIc/undIyVDWKbU/s1600-h/image%5B19%5D.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; margin: 0px; border-right-width: 0px" height="229" alt="Yeah? Well yo mama's so lazy she implements deferred execution!" src="http://lh4.ggpht.com/_LV_l8kYLOwo/SW05-zZH3zI/AAAAAAAAAIg/sl0W2V_ESys/image_thumb%5B11%5D.png?imgmax=800" width="459" border="0" /></a>   </p>  <p>When I was growing up, kids didn't carry money, and they wouldn't let us out of school to go to the shops. I had no way of getting another pencil or a bag of crisps if I realized I'd forgotten it halfway through the day. I was completely dependent on mum making sure all of these things were in my bag to start with.</p>  <p>This is one of the distinguishing features of the repository, as opposed to just cherry-picking bits of data using ad-hoc queries. When using a repository, you are retrieving <strong>deep</strong> <strong>object graphs. </strong>Once I had "retrieved" my rucksack from the repository, I could assume that I also had all the rucksack contents - the lunchbox, the pencil tin, the curiosities and the yo-yo.  (The tantrums I'd throw when I got to school and my yo-yo was missing were really just an early form of NullReferenceException.)</p>  <p>So, assuming our repository pattern is returning nicely-populated object graphs, we now have a whole different set of problems.  </p>  <ul>   <li><strong>Memory consumption. </strong>I had to carry <strong>everything, all day - </strong>and there was only so much space in the locker room at school. The day everyone brought their skateboards in, there wasn't enough space for them all. </li>    <li><strong>Long-running queries.  </strong>If I'd lost my gym shoes or we'd forgotten to defrost any bread to make sandwiches, I'd always end up being late for school. Even though I didn't need the gym shoes until after morning break and the bread until lunchtime, I couldn't leave home without them.  Some days it would rain and games would be cancelled and I wouldn't even <em>need</em> the gym shoes in the end - I'd just carry them around all day for no reason. </li>    <li><strong>Stale objects. </strong>By the time I actually got around to eating lunch, it had been knocking around in my bag for a couple of hours and invariably smelled of bananas. </li> </ul>  <p>Obviously Jim's lazy-loading lunchbox - and presumably the lazy-loading gym-bag, the lazy-loading pencil-case and the lazy-loading gym kit - could solve all these problems, but first let's look at another approach.</p>  <h3>Value Holders - aka "Forget lunch, just give 'em a pizza menu"</h3>  <p>The day Jeremy's parents were away and the babysitter sent him to school with a pizza menu - that's what PoEAA calls a <strong><a href="http://martinfowler.com/eaaCatalog/lazyLoad.html">Value Holder</a></strong>. That particular lunchbox didn't <strong>contain</strong> any lunch, but it <em>did </em>contain a very simple method that Jeremy could use to <strong>get lunch</strong> when he needed it. This works, sure - but asking Jeremy to order pizza and pay for it is violating our separation of concerns. Sometimes, this is OK - but be aware you're doing it. You'd should have a damn good reason for letting a eight-year-old order pizza. I suspect Jeremy's babysitter has no such reason; maybe OO principles aren't required reading at babysitter school any more.</p>  <p>In OO, this will typically show up as a method like Customer.GetOrders() - the customer doesn't actually contain the orders, but it knows how to get them. This obviously requires that GetOrders() knows something about the data store (repository, data access layer, whatever) - so our object is <em>not </em><strong>persistence ignorant.</strong></p>  <h3>Virtual Proxy - aka "The Magic Lazy-Loading Lunchbox"</h3>  <p>Jim's magic lunchbox is something much smarter, though. Jim's lunchbox is a <strong>virtual proxy</strong> - a lightweight, portable "pretend lunchbox" that, as long as we don't open it, looks and behaves just like a regular lunchbox. Jim's lunch isn't in there. It's at home, keeping warm (or cold, ), but - and this is the kicker - the <strong>virtual proxy holds a reference back to it. </strong>Jim can't go home and get his lunch - because lunch-retrieval is not his responsibility - but the magic lunchbox can not only fetch lunches on demand, it can do so completely seamlessly, without Jim being aware that it's even happening. All Jim knows is that every day his mum gives him a rucksack, and when he takes his lunchbox out at lunchtime and opens it, he gets a three-course dinner. </p>  <p>This is much harder to implement seamlessly, but once it's working, it's an absolutely joy to use. Just fire up Customer, get back an apparently fully-populated object, and then do something with Customer.Orders and watch as the database quietly retrieves the exact records you need - no more, no less - and seamlessly weaves the new data into your existing object graph. Almost as cool as watching someone get a three-course roast lunch out of a plastic lunchbox. </p>  <h3>Finally... Eager Loading - aka "Colin"</h3>  <p>Colin carried a huge sports bag with him, everywhere he ever went, with half-a-dozen paperback books, drinks, snacks, sweets, a Spiderman outfit, poster paints, his father's old harmonica... the kid was like a walking junkyard. He'd carry absolutely everything he could think of with him, all the time, just in case he needed it. </p>  <p>Colin's a great example of what we call <strong>eager loading</strong> - where you actually load <strong>more</strong> than you need at initialization time, because (for whatever reason) it's going to be really, really hard to get it later on. If you've ever run Google Reader in offline mode, where it uses the Google Gears engine to get all your blog posts <strong>now</strong> so you can read them later on the train - <strong>that's</strong> eager loading. As with all these techniques, it's worth knowing that it exists (so you know when it might help you), and what it's called (so you know what to Google when you need to use it for real).</p>  <h3>Further Reading - aka "stop with the metaphors already!"</h3>  <p>The principles behind aggregates, domain models and the repository pattern are covered in depth by <a title="Eric Evans on Domain-Driven Design" href="http://www.domainlanguage.com/ddd/index.html">Eric Evans' work on Domain-Driven Design</a> and there are good explanations of the supporting patterns in both Eric's book and Martin Fowler's <a href="http://martinfowler.com/books.html#eaa">Patterns of Enterprise Application Architecture</a> (PoEAA)</p>  <p>The <a href="http://martinfowler.com/eaaCatalog/lazyLoad.html">Value Holder and Virtual Proxy</a> patterns are described under "Lazy Load" in PoEAA, and the Castle Project includes a .NET implementation of the virtual proxy pattern called <a href="http://www.castleproject.org/dynamicproxy/index.html">DynamicProxy</a>, which is used by the lazy-loading features provided in several object-relational mappers, including <a href="http://www.hibernate.org/hib_docs/nhibernate/1.2/reference/en/html_single/#collections-lazy">NHibernate</a> and <a href="http://www.castleproject.org/activerecord/documentation/trunk/usersguide/lazy.html">Castle ActiveRecord</a> (which is built on NHibernate) </p>  <p>Many LINQ providers implement <a href="http://msdn.microsoft.com/en-us/library/bb351562.aspx">IQueryable&lt;T&gt;</a> as a variation on the lazy-loading pattern; take a look at Mike Hadlow's Linq-to-SQL implementation of <a title="Mike Hadlow - Using the IRepository pattern with LINQ to SQL" href="http://mikehadlow.blogspot.com/2008/03/using-irepository-pattern-with-linq-to.html">IRepository&lt;T&gt;</a> to see an example of this in action (and don't miss the <a href="http://mikehadlow.blogspot.com/2009/01/in-search-of-wild-repository.html">controversy over whether IQueryable&lt;T&gt;</a> is violating separation of concerns or not!)</p>  <p>Oh, and the trick is to eat the banana on the way to school, and then at lunchtime you put the bacon crisps inside the ham-and-jam sandwiches. Honest.</p>  <p><small>For the record, names are fictional, any resemblance to any persons living or dead is purely coincidental; the He-Man lunchbox is from www.retrojunk.com , and <a href="http://tweetfu.com/">tweetfu</a> rocks.</small></p>  

<a href="http://www.dotnetkicks.com/kick/?url=http%3a%2f%2fdylanbeattie.blogspot.com%2f2009%2f01%2fstory-of-lazy-loading-lunchbox.html"><img src="http://www.dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=http%3a%2f%2fdylanbeattie.blogspot.com%2f2009%2f01%2fstory-of-lazy-loading-lunchbox.html&bgcolor=215670" border="0" alt="kick it on DotNetKicks.com" /></a>