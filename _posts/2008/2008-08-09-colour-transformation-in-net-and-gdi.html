---
layout: post
title: Colour transformation in .NET and GDI+... aka "What Is The Matrix?"
date: '2008-08-09T11:07:00.001+01:00'
author: Dylan Beattie
tags:
- dotnet
- c#
modified_time: '2017-03-18T15:03:45.167Z'
thumbnail: http://lh5.ggpht.com/dmb197/SJ1sRg_dehI/AAAAAAAAAEE/Rl7DTtZj1us/s72-c/image_thumb%5B2%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-3797945017163645077
blogger_orig_url: http://www.dylanbeattie.net/2008/08/colour-transformation-in-net-and-gdi.html
redirect_from: "/2008/08/colour-transformation-in-net-and-gdi.html"

---

<p>I've been working on some code that converts colour photographs uploaded by users to black-and-white. To do this, I'm using the following code to render an image onto a canvas, using GDI+, and applying a colour transformation in the process:</p>  <pre class="code" style="padding-right: 8px; padding-left: 8px; padding-bottom: 8px; padding-top: 8px; font-family: consolas, andale mono, monospaced; background-color: black"><span style="background: black; color: #40c4ff">private </span><span style="background: black; color: cyan">Bitmap </span><span style="background: black; color: #eddac0">ApplyMatrix</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: cyan">Bitmap </span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: #e0e0e0">) {
    </span><span style="background: black; color: cyan">ColorMatrix </span><span style="background: black; color: #eddac0">matrix </span><span style="background: black; color: silver">= </span><span style="background: black; color: #7cfc00">//TODO: determine appropriate colour matrix! 

    </span><span style="background: black; color: cyan">Bitmap </span><span style="background: black; color: #eddac0">result </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Bitmap</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Width</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Height</span><span style="background: black; color: #e0e0e0">);
    </span><span style="background: black; color: cyan">Rectangle </span><span style="background: black; color: #eddac0">sourceRectangle </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Rectangle</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Width</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Height</span><span style="background: black; color: #e0e0e0">);
    </span><span style="background: black; color: #40c4ff">using </span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: cyan">Graphics </span><span style="background: black; color: #eddac0">g </span><span style="background: black; color: silver">= </span><span style="background: black; color: cyan">Graphics</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">FromImage</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">result</span><span style="background: black; color: #e0e0e0">)) {
        </span><span style="background: black; color: #eddac0">g</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">SmoothingMode </span><span style="background: black; color: silver">= </span><span style="background: black; color: cyan">SmoothingMode</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">HighQuality</span><span style="background: black; color: #e0e0e0">;
        </span><span style="background: black; color: #eddac0">g</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">CompositingQuality </span><span style="background: black; color: silver">= </span><span style="background: black; color: cyan">CompositingQuality</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">HighQuality</span><span style="background: black; color: #e0e0e0">;
        </span><span style="background: black; color: #eddac0">g</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">InterpolationMode </span><span style="background: black; color: silver">= </span><span style="background: black; color: cyan">InterpolationMode</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">HighQualityBicubic</span><span style="background: black; color: #e0e0e0">;

        </span><span style="background: black; color: cyan">ImageAttributes </span><span style="background: black; color: #eddac0">ia </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">ImageAttributes</span><span style="background: black; color: #e0e0e0">();
        </span><span style="background: black; color: #eddac0">ia</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">SetColorMatrix</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">matrix</span><span style="background: black; color: #e0e0e0">);

        </span><span style="background: black; color: cyan">Point </span><span style="background: black; color: #eddac0">upperLeft </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Point</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">);
        </span><span style="background: black; color: cyan">Point </span><span style="background: black; color: #eddac0">upperRight </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Point</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">result</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Width</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">);
        </span><span style="background: black; color: cyan">Point </span><span style="background: black; color: #eddac0">lowerLeft </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Point</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #ff80ff">0</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">result</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Height</span><span style="background: black; color: #e0e0e0">);
        </span><span style="background: black; color: cyan">Point</span><span style="background: black; color: #e0e0e0">[] </span><span style="background: black; color: #eddac0">destinationPoints </span><span style="background: black; color: silver">= </span><span style="background: black; color: #40c4ff">new </span><span style="background: black; color: cyan">Point</span><span style="background: black; color: #e0e0e0">[] { </span><span style="background: black; color: #eddac0">upperLeft</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">upperRight</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">lowerLeft </span><span style="background: black; color: #e0e0e0">};
        </span><span style="background: black; color: #eddac0">g</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">DrawImage</span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">source</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">destinationPoints</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">sourceRectangle</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: cyan">GraphicsUnit</span><span style="background: black; color: silver">.</span><span style="background: black; color: #eddac0">Pixel</span><span style="background: black; color: #e0e0e0">, </span><span style="background: black; color: #eddac0">ia</span><span style="background: black; color: #e0e0e0">);
    }
    </span><span style="background: black; color: #40c4ff">return </span><span style="background: black; color: #e0e0e0">(</span><span style="background: black; color: #eddac0">result</span><span style="background: black; color: #e0e0e0">);
}
</span></pre>

<p>The key to these colour transformations is a ColorMatrix - the GDI+ colour model lets you treat the &lt;R,G,B&gt; elements of a colour as a point in three-dimensional colour space, and apply geometric transformations to that point using matrix multiplication. There's some in-depth discussion of this at <a title="http://www.codeproject.com/KB/GDI-plus/colormatrix.aspx" href="http://www.codeproject.com/KB/GDI-plus/colormatrix.aspx">http://www.codeproject.com/KB/GDI-plus/colormatrix.aspx</a>.</p>

<h3>&quot;Nobody can be told what the matrix is... you have to see it for yourself.&quot;</h3>

<p><a href="http://lh6.ggpht.com/dmb197/SJ1sQ-I1feI/AAAAAAAAAEA/uJuNvxUzYUM/s1600-h/image%5B4%5D.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="255" alt="image" src="http://lh5.ggpht.com/dmb197/SJ1sRg_dehI/AAAAAAAAAEE/Rl7DTtZj1us/image_thumb%5B2%5D.png?imgmax=800" width="324" align="right" border="0" /></a>Even once you've got your head around the underlying mathematics, it's still not easy to work out what matrix values you need to achieve a particular result, so I've hacked together a WinForms app that'll let you tweak the values in real time and see what effect they have.&#160; Nothing fancy - just a bunch of numeric up/down boxes, with tooltips explaining what effect they'll have on the resulting image.</p>

<p>You can download ColorMatrixLab (source and binary) here:</p>

<ul>
  <li>Download <a title="Download source project for ColorMatrixLab" href="http://www.dylanbeattie.net/misc/colormatrixlab.zip">ColorMatrixLab.zip</a></li>
</ul>

<p>(requires the Microsoft .NET 2.0 framework.)</p>  