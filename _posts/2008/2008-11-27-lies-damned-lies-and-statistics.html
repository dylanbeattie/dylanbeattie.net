---
layout: post
title: Lies, Damned Lies, and Statistics
date: '2008-11-27T20:13:00.001Z'
author: Dylan Beattie
tags:
- webdev
- random
modified_time: '2008-11-27T20:13:27.062Z'
thumbnail: http://lh4.ggpht.com/_LV_l8kYLOwo/SS7_Zq_3EqI/AAAAAAAAAHo/BwNyrq-yMfo/s72-c/image_thumb%5B7%5D.png
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-5621815946088422179
blogger_orig_url: http://www.dylanbeattie.net/2008/11/lies-damned-lies-and-statistics.html
---

<p>One of our big customer contracts is up for renegotiation next month. This involves pulling a list of all the search &amp; site activity that originated from that customer over the last year, and then negotiating based on whether usage is up or down. Over the last few years we've seen 10%-15% increases from this particular account, year-on-year, which is good. Yesterday morning I ran the stats report and got this:</p>  <p><a href="http://lh6.ggpht.com/_LV_l8kYLOwo/SS7_YywMOPI/AAAAAAAAAHk/XH-G4JdCtHQ/image%5B15%5D.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="346" alt="" src="http://lh4.ggpht.com/_LV_l8kYLOwo/SS7_Zq_3EqI/AAAAAAAAAHo/BwNyrq-yMfo/image_thumb%5B7%5D.png" width="534" border="0" /></a> </p>  <p>Not good. In fact, very very worrying indeed. Whilst the marketing team went into crisis mode to work out what the hell we were going to do if this was <strong>real, </strong>I started double-checking to make sure this was genuine. It certainly <em>looked</em> genuine. The graph is horribly organic, the way the decline is gradual, occasional peaks and troughs, but with a very, very definite downward trend. In my experience, when software fails, it tends to fail in big straight lines - everything just stops working completely and stays there.</p>  <p>Turns out the stats were wrong - huge sigh of relief all round - but the reason <em>why </em>they were wrong is, I think, quite interesting. These statistics are calculated using some custom logging routines in our (legacy ASP) web code. When a user first hits the site, we create a record in the UserSession table in our database that stores their IP address, user agent string, user ID, and so on. There's some counter fields in that table that are incremented over the course of the session as the user accesses particular resources, so we can build up a fairly accurate picture of which resources get accessed heavily, by whom, and at what times throughout the day.</p>  <p>Well, it turns out our CreateUserSession() routine was failing if the browser's UserAgent string was more than 127 characters. Historically, this was never a problem, but at some point last year Microsoft started putting all sorts of information about .NET framework versions and plugins into the HTTP_USER_AGENT header sent by Internet Explorer (Scott Hanselman has a <a href="http://www.hanselman.com/blog/TheNETFrameworkAndTheBrowsersUserAgentString.aspx">great post about this</a> if you're interested)&#160; As various updates were pushed out to our users via Windows Update and corporate rollouts, the user agent strings were getting longer and longer, until one day they'd exceed 127 characters - and that particular PC would stop showing up in our logs. Whenever they'd roll out new hardware, we'd see the stats increase temporarily, until those new boxes were upgraded and the same thing happened. Hence the gradual decline and the fact that non-IE users were unaffected. </p>  <p>We would have noticed this a long time ago, of course - but the CreateUserSession() call was wrapped in a try/catch block that called a notification function when it caught an exception, and somewhere along the line, the notification mechanism for this particular system had been commented out. I'd love to blame someone else for this, but Subversion has a commit with my name on it sometime last year with the relevant line mysteriously commented out.</p>  <p>I believe the kids are calling that an &quot;epic fail&quot;. I believe they have a point.</p>  