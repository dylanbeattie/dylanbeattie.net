---
layout: post
title: ASP.NET Authentication with Adxstudio
date: '2016-07-27T12:53:00.001+01:00'
author: Dylan Beattie
tags: 
modified_time: '2016-07-27T13:31:34.123+01:00'
thumbnail: https://lh3.googleusercontent.com/-TK5tD9T_0to/V5ignmI3UyI/AAAAAAAAEBc/XSlMNwywMHY/s72-c/image%25255B29%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-224917352334252669
blogger_orig_url: http://www.dylanbeattie.net/2016/07/aspnet-authentication-with-adxstudio.html
redirect_from: "/2016/07/aspnet-authentication-with-adxstudio.html"

---

<p align="justify">I’m looking into options for integrating our shiny new CRM system with our website, so we can provide all sorts of neat self-service capabilities and features. One of the applications I’m investigating is a thing called <a href="https://www.adxstudio.com/">Adxstudio</a> – now owned by Microsoft - which claims to “transform Dynamics CRM into powerful application platform with dozens of apps and starter portals.”</p> <p align="justify"><a href="https://www.adxstudio.com/"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="https://lh3.googleusercontent.com/-TK5tD9T_0to/V5ignmI3UyI/AAAAAAAAEBc/XSlMNwywMHY/image%25255B29%25255D.png?imgmax=800" width="522" height="480"></a></p> <p align="justify">This is one of those situations where we really are dealing with ‘solved problems.’ Email campaigns. Customers updating their own contact details, potentially things like forums, helpdesk/ticketing systems – lots of things which are nice-to-have but really aren’t strategic differentiators, and so there’s a compelling argument to find an off-the-shelf solution and just plug it in. We already have a federated authentication system here at Spotlight – something we built a few years ago that provides basic identity and authentication capabilities on top of OAuth2. At the time we built it, OpenID Connect didn’t exist yet, so we’ve got a system that does basically the same thing but isn’t actually compatible with OpenID Connect – and consequently doesn’t work out-of-the-box with Adxstudio. So I’ve been poking around, trying to work out the best way to plug Adxstudio into our infrastructure so we can evaluate it as a solution.</p> <p align="justify">One of the options on the table was to replace our existing authentication system with IdentityServer; another was to implement OpenID Connect support on top of our existing authentication system – both quite elegant solutions, but both of which involve quite a lot more work than is actually required for what we’re trying to do. </p> <p align="justify">The core requirement here is:</p> <ul> <li> <div align="justify">We already have a CRM Contact record for every user of our system</div></li> <li> <div align="justify">We can look up a user’s CRM Contact GUID during authentication</div></li> <li> <div align="justify">We want to set up the Adxstudio MasterPortal demo so that our customers are seamlessly authenticated and can use Adxstudio features as though they had registered via the Adxstudio registration facility.</div></li></ul> <p align="justify">Now, one of the nice things about Adxstudio is that it’s built as OWIN middleware, and uses the ASP.NET Identity framework to handle authentication – so what we need to do is work out how to translate the CRM Contact GUID into an IPrincipal/IIdentity instance that we can assign to the HttpContext.Current.User property, and hope that Adxstudio then does the right thing once the HttpContext User is set correctly.</p> <p align="justify">Adxstudio provides an implementation of ApplicationUserManager that’s already registered with the OWIN model, which accepts a CRM Contact GUID (as a string) and returns an instance of ApplicationUser that we can use to spin up a new ClaimsIdentity. So the simplest possible approach here is this snippet of code:</p> <p><font face="Consolas">protected void Application_AuthenticateRequest(object sender, EventArgs e) {<br>&nbsp; Guid userGuid;<br>&nbsp; var cookie = Request.Cookies["crm_contact_guid"];<br>&nbsp; if (cookie != null &amp;&amp; Guid.TryParse(cookie.Value, out crmContactGuid)) {<br>&nbsp;&nbsp;&nbsp; var http = HttpContext.Current;<br>&nbsp;&nbsp;&nbsp; var owin = http.GetOwinContext();<br>&nbsp;&nbsp;&nbsp; var userManager = owin.Get&lt;ApplicationUserManager&gt;();<br>&nbsp;&nbsp;&nbsp; var user = userManager.FindById(crmContactGuid.ToString());<br>&nbsp;&nbsp;&nbsp; var identity = user.GenerateUserIdentityAsync(userManager).Result;<br>&nbsp;&nbsp;&nbsp; HttpContext.Current.User = new RolePrincipal(identity);<br>&nbsp; }<br>}</font></p> <p align="justify">Doing this with a Contact that’s been created via the Adxstudio registration thing works just fine – but trying to do it with a ‘vanilla’ contact blows up:</p> <p align="justify"><a href="https://lh3.googleusercontent.com/-jZC3i_RSBJM/V5ign5_p-RI/AAAAAAAAEBg/V-4PlUYMt1k/s1600-h/image%25255B6%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://lh3.googleusercontent.com/-9vyeqtUFEq4/V5igoZNwyRI/AAAAAAAAEBk/JF1kGMdouVw/image_thumb%25255B4%25255D.png?imgmax=800" width="564" height="316"></a>As you can see from that stack trace, deep down buried under several layers of Adxstudio and ASP.NET Identity code, something is trying to construct a System.Security.Claims.Claim() instance and it’s blowing up because we’re passing in a null value for something that’s not allowed to be null. Unfortunately for us, because we don’t have the source for the thing that’s actually blowing up, we can’t see what the actual parameter values are that are causing the exception… so it’s time for a bit of hunch-driven development. :)</p> <p align="justify">I’d already noticed that when you install Adxstudio into your CRM system, it adds a bunch of custom attributes to the Contact entity in Dynamics CRM; here’s a dump of those attributes for a working contact:</p> <table cellspacing="0" cellpadding="8" width="540" border="2"> <tbody> <tr> <td valign="top" width="228"><strong>Attribute Key</strong></td> <td valign="top" width="312"><strong>Value</strong></td></tr> <tr> <td valign="top" width="228">adx_changepasswordatnextlogon</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_identity_emailaddress1confirmed</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_identity_lockoutenabled</td> <td valign="top" width="312">True</td></tr> <tr> <td valign="top" width="228">adx_identity_logonenabled</td> <td valign="top" width="312">True</td></tr> <tr> <td valign="top" width="228">adx_identity_mobilephoneconfirmed</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_identity_passwordhash </td> <td valign="top" width="312"><em><font style="background-color: #000000" color="#000000">(omitted for security reasons)</font></em></td></tr> <tr> <td valign="top" width="228">adx_identity_securitystamp</td> <td valign="top" width="312">ca49a664-0385-4eb4-90c0-6283c9e704ea</td></tr> <tr> <td valign="top" width="228">adx_identity_twofactorenabled</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_identity_username</td> <td valign="top" width="312">ali_baba</td></tr> <tr> <td valign="top" width="228">adx_lockedout </td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_logonenabled</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_profilealert</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_profileisanonymous</td> <td valign="top" width="312">False</td></tr> <tr> <td valign="top" width="228">adx_profilemodifiedon</td> <td valign="top" width="312">2016-07-20 09:18:43</td></tr></tbody></table> <p align="justify">The ASP.NET Identity model is generally pretty flexible, but I have a hunch that the <strong>username</strong> and the <strong>security stamp</strong> are both required fields because they’re fundamental to the way authentication works. So, let’s try inserting some code into the AuthenticateRequest handler that will check these fields exist, and update them directly in CRM if they don’t:</p> <p><font face="Consolas">protected void Application_AuthenticateRequest(object sender, EventArgs e) {<br>&nbsp; Guid userGuid;<br>&nbsp; var cookie = Request.Cookies["crm_contact_guid"];<br>&nbsp; if (cookie != null &amp;&amp; Guid.TryParse(cookie.Value, out userGuid)) {<br>&nbsp;&nbsp;&nbsp; </font><font face="Consolas">var http = HttpContext.Current;<br>&nbsp;&nbsp;&nbsp; var owin = http.GetOwinContext();<br>&nbsp;&nbsp;&nbsp; var userManager = owin.Get&lt;ApplicationUserManager&gt;();<br></font><font face="Consolas">&nbsp;&nbsp;&nbsp; var user = userManager.FindById(userGuid.ToString());<br><strong><font color="#ff0000">&nbsp;&nbsp;&nbsp; if (String.IsNullOrEmpty(user.UserName) <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String.IsNullOrEmpty(user.SecurityStamp)<br>&nbsp;&nbsp;&nbsp;&nbsp; ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // "Xrm" is the connection string name from web.config<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var crm = new OrganizationService("Xrm")) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var entity = crm.Retrieve("contact", userGuid, new ColumnSet(true));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entity.Attributes["adx_identity_securitystamp"] = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid.NewGuid().ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entity.Attributes["adx_identity_username"] = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid.NewGuid().ToString().Substring(0, 8);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crm.Update(entity);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</font></strong><br>&nbsp;&nbsp;&nbsp; var identity = user.GenerateUserIdentityAsync(userManager).Result;<br>&nbsp;&nbsp;&nbsp; HttpContext.Current.User = new RolePrincipal(identity);<br>&nbsp; }<br>}</font></p> <p align="justify">(For the sake of this demo, all we care about is making sure those values are no longer null. In reality, make sure you understand the significance of the username and security stamp fields in the identity model, and populate them with suitable values.)</p> <p align="justify">OK, this now works sometimes – but only following an IISRESET. Turns out that Adxstudio is actually caching data from CRM locally, so although that new chunk of code is updating the Contact entity into a valid identity, the Adxstudio local cache doesn’t see those changes because it’s looking at an out-of-date copy of the Contact entity. So… time to configure some cache invalidation.</p> <p align="justify">You can <a href="https://community.adxstudio.com/products/adxstudio-portals/documentation/developers-guide/cache/web-notifications/">read about Adxstudio’s web notifications feature here</a>. Adxstudio includes some code that will call a cache invalidation handler on your own site every time an entity is updated. Which works just fine IF CRM Online can see your Adxstudio portal site. And right now I’m running CRM Online as a 30-day trial and I’m running Adxstudio on localhost, and my workstation isn’t on the internet, so CRM Online can’t see it.</p> <p align="justify">Time to fire up my favourite toolchain – Runscope and Ngrok. First, I’ve set up ngrok so that any requests to mytunnel.ngrok.io will be forwarded to my local machine – you’ll need a paid ngrok license to use custom tunnel names, but if you’re using the free version try this:</p> <p align="justify"><font face="Consolas">D:\tools\ngrok&gt;<strong>ngrok http –host-header=adx.local 80</strong></font>&nbsp;</p> <p align="justify"><a href="https://lh3.googleusercontent.com/-swh4oHhYm9g/V5igomieR2I/AAAAAAAAEBo/jrdVb3dYybU/s1600-h/image%25255B14%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; border-left: 0px; display: block; padding-right: 0px; margin-right: auto" border="0" alt="image" src="https://lh3.googleusercontent.com/--BmVOe8_J98/V5igpODnO3I/AAAAAAAAEBs/QE-_ToioXyY/image_thumb%25255B8%25255D.png?imgmax=800" width="613" height="355"></a></p> <p align="justify">Now, as long as that NGrok process is running, you can hit that URL – <a href="http://ef736c25.ngrok.io/">http://ef736c25.ngrok.io/</a> – from anywhere on the internet, and it’ll be tunneled to localhost on port 80 and have the host-header rewritten to be adx.local. This neatly solves the problem of CRM Online not being able to connect to my local Adxstudio instance.</p> <p align="justify">Next, just to give us a bit of insight into what’s going on, I’m going to set up a Runscope bucket for that. Remember – we need to route requests to /cache.axd on our local Adxstudio portal instance, via ngrok, so here’s how to get the Runscope URL you’ll need:</p> <p align="justify"><a href="https://lh3.googleusercontent.com/-Dxxx-r_wQIY/V5igpaXVyhI/AAAAAAAAEBw/b-JL1BQqQ-U/s1600-h/image%25255B22%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="image" src="https://lh3.googleusercontent.com/-T8XUoeZQILs/V5igphn3EQI/AAAAAAAAEB0/d1Bj2R6xqGY/image_thumb%25255B14%25255D.png?imgmax=800" width="555" height="405"></a></p> <p align="justify">So, last step – you see that big URL in the middle?&nbsp; We need to tell the Adxstudio Web Notifications plugin to notify that URL every time something changes. The option is under CRM &gt; Settings &gt; Web Notification URLs.</p> <p align="justify">Note that the Adxstudio documentation refers to a Configuration screen accessible from the Solutions &gt; Adxstudio Portals Base. It appears this screen doesn’t exist any more – I certainly couldn’t find any trace of it in my CRM Online instance – but it also appears it isn’t necessary, because as soon as I’d created and active Web Notification URL things started happening.</p> <p align="justify">So, now we have something that works – but it still fails on the first Portal request for a particular Contact, probably because the Adxstudio cache isn’t picking up those two new fields fast enough for the login to succeed. To work around this, I’ve put in a thread sleep and then an HTTP redirect, so the first time a user lands on the portal they’ll get a slight delay whilst we populate their Adxstudio attributes, and then they’ll get their personalised screen:</p><font color="#666666" face="Consolas">protected void Application_AuthenticateRequest(object sender, EventArgs e) {<br>&nbsp; Guid userGuid;<br>&nbsp; var cookie = Request.Cookies["crm_contact_guid"];<br>&nbsp; if (cookie != null &amp;&amp; Guid.TryParse(cookie.Value, out userGuid)) {<br>&nbsp;&nbsp;&nbsp; </font><font color="#666666" face="Consolas">var http = HttpContext.Current;<br>&nbsp;&nbsp;&nbsp; var owin = http.GetOwinContext();<br>&nbsp;&nbsp;&nbsp; var userManager = owin.Get&lt;ApplicationUserManager&gt;();<br></font><font color="#666666" face="Consolas">&nbsp;&nbsp;&nbsp; var user = userManager.FindById(userGuid.ToString());<br><strong>&nbsp;&nbsp; </strong> if (String.IsNullOrEmpty(user.UserName) <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String.IsNullOrEmpty(user.SecurityStamp)<br>&nbsp;&nbsp;&nbsp;&nbsp; ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var crm = new OrganizationService("Xrm")) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var entity = crm.Retrieve("contact", userGuid, new ColumnSet(true));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entity.Attributes["adx_identity_securitystamp"] = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid.NewGuid().ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; entity.Attributes["adx_identity_username"] = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid.NewGuid().ToString().Substring(0, 8);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crm.Update(entity);<br><font color="#ff0000"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.Sleep(TimeSpan.FromSeconds(5));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Redirect back to the same page, so that Adxstudio will <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // retrieve a fresh copy of the cached data.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http.Response.Redirect(http.Request.RawUrl);</strong></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; var identity = user.GenerateUserIdentityAsync(userManager).Result;<br>&nbsp;&nbsp;&nbsp; HttpContext.Current.User = new RolePrincipal(identity);<br>&nbsp; }<br>}</font> <p align="justify">And it works. The final step for me was to spin up a separate web app that lists all the Contacts in the CRM system, with a login handler that puts the CRM Contact GUID into a cookie and redirects the browser to <a href="http://adx.local/">http://adx.local/</a> – and it works. No registration, no login, and any user with a valid CRM Contact GUID can now log directly into the Adxstudio MasterPortal example. </p>