---
layout: post
title: The Mystery of the Chinese Junk
date: '2016-10-25T22:33:00.001+01:00'
author: Dylan Beattie
tags: 
modified_time: '2016-10-25T22:33:51.904+01:00'
thumbnail: https://lh3.googleusercontent.com/-xaxSLtPDR34/WA_PtN6h1xI/AAAAAAAAEHQ/VCnL_rIORmE/s72-c/image_thumb2.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-5571973709620003208
blogger_orig_url: http://www.dylanbeattie.net/2016/10/the-mystery-of-chinese-junk.html
---

<p align="justify">You know it’s going to be one of those days when, just as you’re about to put on your headphones and get into ‘the zone’, you overhear somebody saying the fateful words ‘ok, then maybe we’ll need to get Dylan to look at it.’</p> <p align="justify">See, amongst the many hats I wear in the course of a given week, there’s one that’s probably labelled ‘<a href="https://medium.com/@ziobrando/the-rise-and-fall-of-the-dungeon-master-c2d511eed12f">dungeon master</a>’ I’m the one who remembers where all the bodies are buried, because – for all sorts of reasons that made very good sense at the time – I probably helped bury most of them. And on this particular day, the source of so much excitement was our venerable Microsoft Dynamics CRM v4 server. It started out with a sort of general grumbling on the support channel about CRM4 being slow… but by the time it was handed over to me to look into, it was beautifully summarised as ‘dude… there’s Chinese in the Windows event log’</p> <p align="justify">And, sure enough, there is – complete with the lovely Courier typeface that Windows Event Viewer kicks into when you get errors so weird that good old Microsoft Sans Serif can’t even display them:</p> <p><a href="https://lh3.googleusercontent.com/-3IUaxe95aKA/WA_PrjO9UdI/AAAAAAAAEHM/quLqwgn71Uk/s1600-h/image4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://lh3.googleusercontent.com/-xaxSLtPDR34/WA_PtN6h1xI/AAAAAAAAEHQ/VCnL_rIORmE/image_thumb2.png?imgmax=800" width="631" height="480"></a></p> <p align="justify">Now, whilst it’s been a while since I’ve done any serious work on our old CRM system, I’m pretty sure it’s not supposed to do <em>that</em> – so we start investigating. Working theory #1: some sort of vulnerability has resulted in attackers injecting Chinese characters into our database – whilst CRM4 is generally pretty well insulated from any public-facing code, there’s one or two places where signup forms would generate CRM Leads, that sort of thing. So we start <a href="http://stackoverflow.com/questions/9185871/how-to-search-sql-server-database-for-string">grepping the entire database</a> for one of the Chinese strings we’ve found in the event log.</p> <p>Whilst this is going on – and trust me, it takes a while – I decide to share my excitement via the wonder of social media. This turns out to be a Really Good idea, because... well, here's what happened...</p> <p lang="ja" dir="ltr">"The incoming tabular data stream TDS RPC protocol stream is incorrect. Parameter ("䐀攀氀攀琀椀漀渀匀琀愀琀攀..." Oh. It's gonna be one of THOSE days.</p>— Dylan Beattie (@dylanbeattie) <a href="https://twitter.com/dylanbeattie/status/788310445182558208">October 18, 2016</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>  <p lang="en" dir="ltr"><a href="https://twitter.com/dwm">@dwm</a> <a href="https://twitter.com/dylanbeattie">@dylanbeattie</a> The low bits are all null, so this probably UTF-16LE being mistaken for UTF-16BE (or vice versa...?). <a href="https://t.co/D0IO4px9YE">pic.twitter.com/D0IO4px9YE</a></p>— Fake Unicode ⁰ ⁧ (@FakeUnicode) <a href="https://twitter.com/FakeUnicode/status/788327150633914369">October 18, 2016</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>  <p>You see in @FakeUnicode's screenshot there, the words ‘DeletionState’ appear quite clearly at the bottom of the message?  <p><img src="https://pbs.twimg.com/media/CvCzUDaUMAAXnOi.jpg:large" width="639" height="480"></p> <p align="justify">Whilst this is going on, our database search comes back reporting that there’s no mysterious Chinese characters in any of our CRM database tables. Which is good, since it means we probably haven’t been compromised. So, next step is to work through that Unicode lead, see if that gets us anywhere. Because .NET has a built-in encoding for big-endian Unicode, this is pretty simple:</p> <blockquote> <p><font face="Consolas">var source = "䐀攀氀攀琀椀漀渀匀琀愀琀攀";<br>var bytes = Encoding.BigEndianUnicode.GetBytes(source);<br>var result = Encoding.Unicode.GetString(bytes);<br>Console.WriteLine(result);</font><br></p></blockquote> <p align="justify">Turns out – just as in FakeUnicode’s screenshot – that’s the text “DeletionState” with the byte order flipped. We grabbed a few examples of the ‘Chinese’ text from the event log, ran it through this – sure enough, in every single case it’s a valid CRM database query that’s somehow been flipped into wrong-endian Unicode. At this point we start suspecting some sort of latent bug – this is old software, running on an old operating system,talking to an old database server, and sure enough, a bit of googling turns up a couple of&nbsp; likely-looking issues, most of which are addressed in various updates to SQL Server 2008. We take a VM snapshot in case everything goes horribly wrong, and one of the Ops gang volunteers to work late to get the server patched.</p> <p>Next morning, turns out the server hasn’t been patched – because every single download of the relevant service pack has been corrupted. At which point all bets are off, because chances are the problem is actually network-related – which also explains where the ‘Chinese’ is coming from.</p> <p>OK, let’s capture a stream of bytes from somewhere. Like, say, from the TDS data stream used by the MSCRMAsyncService</p> <p><a href="https://lh3.googleusercontent.com/-t_Ie-Up24wQ/WA_PuIw2EiI/AAAAAAAAEHU/ALilmLkJvaU/s1600-h/image%25255B5%25255D.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://lh3.googleusercontent.com/-SlCbLlPWg2o/WA_PupB147I/AAAAAAAAEHY/VbieOilKFMU/image_thumb%25255B2%25255D.png?imgmax=800" width="589" height="56"></a></p> <p>What does that say? If you think you know the answer, you’re wrong. Pop off and read <a href="http://www.joelonsoftware.com/articles/Unicode.html">The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets (No Excuses!)</a> – done? Awesome. NOW what do you think it says?</p> <p>See, we have no idea. It’s a stream of bytes. Without some indication of how we’re supposed to interpret those bytes, it’s meaningless. OK, I’ll give you a clue – it’s UTF-16. Now can you tell what it says? No, you can’t – because (1) you don’t know whether it’s big-endian or little-endian, and (2) you don’t know where it started.</p> <p>If we assume it’s big-endian, then the first byte pair – 00 48 – would encode the character ‘H’, the second byte pair – 00 65 – would encode ‘e’, and so on. If we assume it’s little-endian, then the first byte pair – 00 48 – encodes the character 䠀 – and suddenly the mysterious Chinese characters in the event log start to make sense.</p> <p><a href="https://lh3.googleusercontent.com/-J41XOb2GBkA/WA_PvIy_84I/AAAAAAAAEHc/W1gws_KCZHk/s1600-h/image%25255B11%25255D.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="https://lh3.googleusercontent.com/-Aee2ymHm7z4/WA_Pvlqgz6I/AAAAAAAAEHg/CGGRXWhsAqo/image_thumb%25255B6%25255D.png?imgmax=800" width="599" height="175"></a></p> <p>Of course, the data stream between the MSCRMAsyncService and the SQL server hasn’t actually flipped from little-endian UTF-16 to big-endian – what’s happened is that the network connection between them is dropping bytes. And if you drop a single byte – or any odd number of bytes – from a little-endian Unicode stream, you get a sort of off-by-one error right along the rest of the data stream, resulting in all sorts of weirdness – including Chinese in the event logs.</p> <p>Turns out there was a problem with the virtual network interface on the SQL Server box – which was causing poor performance, timeouts, bizarre query syntax errors, Chinese in the event logs, and corrupted service pack downloads. Fortunately the databases themselves were intact, so we offlined them, cloned the virtual disk they were sitting on, attached that to a different server and brought them back online.</p> <p>Every once in a while, you get a weird problem like this. I’ve seen maybe half-a-dozen problems in my entire career that made absolutely no sense until they turned out to be a faulty network connection, at which point generally you not only solve the problem, but explain a whole load of other weirdness that you hadn’t got round to investigating yet. The only thing more fun than dodgy networks is dodgy memory – but that’s a post for another day.</p> <p>Oh, and if you’re wondering about the title of this post, <a href="https://en.wikipedia.org/wiki/The_Mystery_of_the_Chinese_Junk">you clearly haven’t studied the classics</a>.</p>