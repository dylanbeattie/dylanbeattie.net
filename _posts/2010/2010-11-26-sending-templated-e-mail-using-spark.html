---
layout: post
title: Sending Templated E-mail using the Spark View Engine
date: '2010-11-26T11:46:00.001Z'
author: Dylan Beattie
tags:
- asp.net
- c#
- coding
modified_time: '2010-11-26T11:49:48.838Z'
thumbnail: http://farm1.static.flickr.com/47/145096304_0ff99eec39_t.jpg
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-6579781630100908216
blogger_orig_url: http://www.dylanbeattie.net/2010/11/sending-templated-e-mail-using-spark.html
redirect_from: "/2010/11/sending-templated-e-mail-using-spark.html"

---

<p><a title="Spark photograph © SCholewiak via Flickr" href="http://www.flickr.com/photos/scholewiak/145096304/sizes/m/in/photostream/"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: 0px 0px 20px 20px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top: 0px; border-right: 0px; padding-top: 0px" title="" border="0" alt="Spark photo © SCholewiak via Flickr" align="right" src="http://farm1.static.flickr.com/47/145096304_0ff99eec39.jpg" width="320" height="241" /></a>We have a couple of systems that send personalized e-mail notifications to our users, and for a while I’ve been looking for a nice way to use a proper MVC-style view engine to populate the templates for personalizing these e-mails. The problem is, most of the ASP.NET view engines are so tightly bound to System.Web and things like HttpContext.Current and the VirtualPathProvider that running them in a standalone console application is really quite unpleasant.</p>  <p>Well, with a bit of hacking around and some help from <a href="http://twitter.com/#!/RobertTheGrey">@RobertTheGrey</a>, I’ve finally got the awesome <a href="http://sparkviewengine.com/">Spark view engine</a> running within a console app. No fake VirtualPathProviders, no mocking or spoofing HttpContext.Current – it just works.</p>  <p>The secret is this little snippet of code here:</p>  <blockquote>   <p><font face="Consolas">var templateFolder = @&quot;D:\Templates\&quot;;        <br />var viewFolderParameters = new Dictionary&lt;string, string&gt; {         <br />&#160;&#160;&#160; {&quot;basePath&quot;, templateFolder}         <br />};         <br />var settings = new SparkSettings();         <br />settings.SetPageBaseType(typeof(TemplateBase));         <br />settings.AddViewFolder(ViewFolderType.FileSystem, viewFolderParameters);         <br />engine = new SparkViewEngine(settings);</font></p> </blockquote>  <p>which spins up a fresh SparkSettings configuration object, tells it to use your own TemplateBase class and the templates folder you’ve specified. The method that actually does the population looks like this:</p>  <blockquote>   <p><font face="Consolas">public string Populate(string templateFileName, object data) {&#160; <br />&#160; var writer = new StringWriter();&#160; <br />&#160; var descriptor = new SparkViewDescriptor();&#160; <br />&#160; descriptor.AddTemplate(templateFileName);&#160; <br />&#160; var view = (TemplateBase)engine.CreateInstance(descriptor);&#160; <br />&#160; try {&#160; <br />&#160;&#160;&#160; view.ViewData = new ViewDataDictionary(data);&#160; <br />&#160;&#160;&#160; view.RenderView(writer);&#160; <br />&#160; } finally {&#160; <br />&#160;&#160;&#160; engine.ReleaseInstance(view);&#160; <br />&#160; }&#160; <br />&#160; return (writer.ToString());&#160; <br />}</font></p> </blockquote>  <p>so you end up with little snippets like this:</p>  <blockquote>   <p><font face="Consolas">foreach(var user in userRepository.RetrieveUsersWhoShouldGetWelcomeEmails()) {       <br />&#160;&#160;&#160; var htmlBody = templater.Populate(&quot;welcome_html.spark”, user):        <br />&#160;&#160;&#160; var textBody = templater.Populate(“welcome_text.spark”, user):        <br />&#160;&#160;&#160; mailServer.SendMail(</font><a href="mailto:&ldquo;me@mysite.com"><font face="Consolas">“me@mysite.com</font></a><font face="Consolas">”, user.Email, “Welcome!”, textBody, htmlBody);       <br />}</font></p> </blockquote>  <p>There’s a <a href="https://github.com/loudej/spark/tree/master/src/Samples/DirectUsage/SparkEmailMerge">full working example in the Spark repository on GitHub</a> if you’re interested.</p>  <p><font size="1">Spark photo © <a href="http://www.flickr.com/photos/scholewiak/145096304/sizes/m/in/photostream/">SCholewiak via Flickr</a> – used under Creative Commons attribution license.</font></p>  