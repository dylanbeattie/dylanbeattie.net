---
layout: post
title: Automating Secure FTP Backups to a Windows 2008 Server
date: '2010-09-13T14:36:00.001+01:00'
author: Dylan Beattie
tags:
- howto
- tools
- dotnet
- c#
modified_time: '2017-03-18T15:03:45.160Z'
thumbnail: http://lh3.ggpht.com/_de7B8BtZZIw/TI5rRXhDHvI/AAAAAAAAACk/0lyQkBc2XAc/s72-c/image_thumb%5B21%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-3633510057781509532
blogger_orig_url: http://www.dylanbeattie.net/2010/09/automating-secure-ftp-backups-to.html
---

<p>I’ve been looking into solutions for shipping database backups and log-files to a remote server as part of our backup strategy. Requirements are pretty simple:</p>  <ul>   <li>It’s got to be completely automated</li>    <li>A daily run has to take less than 6 hours so it’ll finish overnight whilst our connection is quiet</li>    <li>Transfers need to be encrypted to stop people sniffing our packets</li>    <li>I don’t want to spend a lot of money</li>    <li>If I can get away without lots of complicated (read: <em>fragile</em>) command-line switches, then that would be a bonus</li> </ul>  <p>Now, there’s four common protocols for doing secure file transfers - <a href="http://en.wikipedia.org/wiki/SSH_file_transfer_protocol">SFTP</a>, <a href="http://en.wikipedia.org/wiki/FTPS">FTPS</a>, <a href="http://en.wikipedia.org/wiki/FTP_over_SSH#FTP_over_SSH_.28not_SFTP.29">FTP+SSH</a>, and <a href="http://en.wikipedia.org/wiki/Secure_copy">SCP</a>. The specifics aren’t important – what matters is that they’re incompatible, so your client and server have to be using the same protocol, otherwise nothing will work. There’s also various dedicated tools such as rsync, robocopy, xcopy, SyncBack, DeltaCopy… the list goes on. Setting up rsync on Windows is a bit fiddly – not to mention the dozens of subtle and nefarious <a href="http://www.samba.org/ftp/rsync/rsync.html">command-line switches</a> available to rsync.exe – and whilst I love a bit of cygwin hacking as much as anyone else, I’d really rather use something a little more intuitive here. I did try DeltaCopy, a GUI wrapper around rsync, but I quickly ran into security problems with SSH keys and username/password combinations. Since I wanted to avoid open folder shares on the remote system, tools like <a href="http://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/xcopy.mspx?mfr=true">xcopy</a> and <a href="http://technet.microsoft.com/en-us/library/cc733145(WS.10).aspx">robocopy</a> were out. </p>  <p>In the past, I’ve had great results with <a href="http://www.vandyke.com/">Vandyke Software</a>’s <a href="http://www.vandyke.com/products/vshell/">VShell</a>, a commercial Windows SSH server, but whilst putting this lot together, I discovered that in Windows Server 2008, you can set up an FTP server to encrypt connections via SSL (it’ll even use the same certificate as your website). That’s good, by the way – I think things are always cheaper &amp; easier when Windows does them out of the box.</p>  <p>So – assuming you’ve already got a Windows 2008 Server running IIS, and you’ve already got a certificate installed, then log onto the server, fire up IIS, create a new FTP site, switch on SSL, bingo. </p>  <p><a href="http://lh6.ggpht.com/_de7B8BtZZIw/TI5rQ1rEUiI/AAAAAAAAACg/aGtVFfAzl6g/s1600-h/image%5B37%5D.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/_de7B8BtZZIw/TI5rRXhDHvI/AAAAAAAAACk/0lyQkBc2XAc/image_thumb%5B21%5D.png?imgmax=800" width="662" height="576" /></a>&#160;</p>  <p>Just to sanity-check that everything’s working, fire up <a title="WinSCP is an open source free SFTP client and FTP client for Windows." href="http://winscp.net/eng/index.php">WinSCP</a>, create a new session using FTP with SSL Explicit Encryption, and you should be able to connect to your new secure server.</p>  <p><a href="http://lh4.ggpht.com/_de7B8BtZZIw/TI5rR76WkHI/AAAAAAAAACo/xhShRQ1Kd_M/s1600-h/image%5B30%5D.png"><img style="border-right-width: 0px; margin: 10px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_de7B8BtZZIw/TI5rSkc4BfI/AAAAAAAAACs/jOPqs7VqMME/image_thumb%5B18%5D.png?imgmax=800" width="529" height="374" /></a> OK – so far, so good. We can connect, we can see a directory listing. Now what I want to do is to automate the client side of things, and for this bit, I’m going to use a superb bit of software called <a href="http://www.superflexible.com/">Super Flexible File Synchronizer</a>. This is something I’ve only discovered recently, but so far, I’m delighted with it. It’s got native support for FTP. SFTP, WebDAV and HTTP, as well as Google Docs, Amazon S3 and Azure (!), plus a built-in scheduler, mail notification facility… as I said, it’s looking very promising.</p>  <p><a href="http://http://www.superflexible.com/"><img style="border-bottom: 0px; border-left: 0px; margin: 0px 0px 20px 20px; display: inline; border-top: 0px; border-right: 0px" border="0" align="right" src="http://www.superflexible.com/images/SiteName.png" /></a></p>  <p>Right, time for some actual computer science – complete with experimental data and graphs and everything. I want to know how fast this thing is going to go, and I want to know how much the encryption’s going to slow things down, so I’ve put together 72Mb of assorted database backups, TIFF files and documents, and transferred them up to the remote server using various settings. Results here are the average of five runs for each combination.</p>  <p>There’s a slightly odd setting in Super Flexible File Synchroniser – when you’re setting up an Internet target, if you pick FTP, it’ll give you a choice of libraries – cryptically called 1, 2 and 3. </p>  <p><a href="http://lh4.ggpht.com/_de7B8BtZZIw/TI5rT3CS-8I/AAAAAAAAACw/s-sJSKB0knc/s1600-h/image%5B43%5D.png"><img style="border-right-width: 0px; margin: 10px auto; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_de7B8BtZZIw/TI5rUXgs2pI/AAAAAAAAAC0/bVLpD28C6rU/image_thumb%5B25%5D.png?imgmax=800" width="392" height="394" /></a> I’m guessing that under the hood, there’s three different off-the-shelf FTP libraries in there, and the option lets you pick another one if the default doesn’t play nicely with your particular server. (Yeah, like anyone’s ever going to need <em>that…)</em></p>  <p>So, numbers. I ran five different settings – network share (i.e. copying straight to <a href="file://\\myserver\backups">\\myserver\backups</a> using Windows file sharing), “open” FTP (no SSL), and then each of the three FTP libraries with the SSL option switched on.</p>  <table style="margin: 10px auto" border="1" cellspacing="0" cellpadding="2"><tbody>     <tr>       <td>&#160;</td>        <td rowspan="2">         <p align="center">Total Time</p>       </td>        <td colspan="3">         <p align="center">Time per File</p>       </td>        <td colspan="3">         <p align="center">Transfer Speed</p>       </td>     </tr>      <tr>       <td>         <p align="center">&#160;</p>       </td>        <td>         <p align="center">Average</p>       </td>        <td>         <p align="center">Fastest</p>       </td>        <td>         <p align="center">Slowest</p>       </td>        <td>         <p align="center">Average</p>       </td>        <td>         <p align="center">Slowest</p>       </td>        <td>         <p align="center">Fastest</p>       </td>     </tr>      <tr>       <td>         <p align="left"><strong>FTP</strong></p>       </td>        <td>         <p align="right">00:00:46</p>       </td>        <td>         <p align="right">2 </p>       </td>        <td>         <p align="right">0 </p>       </td>        <td>         <p align="right">16 </p>       </td>        <td>         <p align="right">1,944 </p>       </td>        <td>         <p align="right">146 </p>       </td>        <td>         <p align="right">2,274 </p>       </td>     </tr>      <tr>       <td>         <p align="left"><strong>SMB</strong></p>       </td>        <td>         <p align="right">00:00:45</p>       </td>        <td>         <p align="right">2 </p>       </td>        <td>         <p align="right">0 </p>       </td>        <td>         <p align="right">16 </p>       </td>        <td>         <p align="right">1,976 </p>       </td>        <td>         <p align="right">86 </p>       </td>        <td>         <p align="right">2,451 </p>       </td>     </tr>      <tr>       <td>         <p align="left"><strong>FTP+SSL (Library 1)</strong></p>       </td>        <td>         <p align="right">00:08:22</p>       </td>        <td>         <p align="right">22 </p>       </td>        <td>         <p align="right">0 </p>       </td>        <td>         <p align="right">41 </p>       </td>        <td>         <p align="right">148 </p>       </td>        <td>         <p align="right">1 </p>       </td>        <td>         <p align="right">870 </p>       </td>     </tr>      <tr>       <td>         <p align="left"><strong>FTP+SSL (Library 2)</strong></p>       </td>        <td colspan="7">         <p align="center"><font color="#ff0000"><strong>FAIL</strong></font></p>       </td>     </tr>      <tr>       <td>         <p align="left"><strong>FTP+SSL (Library 3)</strong></p>       </td>        <td>         <p align="right">00:00:40</p>       </td>        <td>         <p align="right">2 </p>       </td>        <td>         <p align="right">0 </p>       </td>        <td>         <p align="right">14 </p>       </td>        <td>         <p align="right">2,161 </p>       </td>        <td>         <p align="right">129 </p>       </td>        <td>         <p align="right">2,521 </p>       </td>     </tr>   </tbody></table>  <p align="center"><a href="http://lh6.ggpht.com/_de7B8BtZZIw/TI5rVGYf0II/AAAAAAAAAC4/QhCKEUk04bg/s1600-h/image%5B62%5D.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_de7B8BtZZIw/TI5rVoMNuPI/AAAAAAAAAC8/4snssgth2Ng/image_thumb%5B36%5D.png?imgmax=800" width="751" height="344" /></a> </p>  <p>A couple of things to note:</p>  <ol>   <li>FTP Library 2 just didn’t work – it wouldn’t even connect to the remote server to retrieve a directory listing.</li>    <li>FTP Library 1 clearly had some issues – a typical run took well over eight minutes, and the subsequent logs were littered with timeouts and stuff like this:</li>    <blockquote>     <p><font face="Consolas">COPY L-&gt;R d:\FileDemo\F00090820-0103.tif&#160; (889.7kB)         <br />FTP Exception (5): EclSocketError Timeout error occured @ 009283D0          <br />COPY L-&gt;R d:\FileDemo\F00090820-0104.tif&#160; (851.6kB)          <br />FTP Exception (5): EclSocketError Timeout error occured @ 009283D0</font></p>   </blockquote> </ol>  <p>Fortunately – FTP Library #3 worked perfectly, and gave transfer speeds that were actually <em>faster</em> than the raw FTP connection. I’m thinking that’s probably down to variations in test conditions (time of day, traffic. and so on) but even allowing for a little experimental error, it’s definitely fast enough to work with.</p>  <p>We’re looking at transferring about 20Gb worth of database backups and photographs a day. Based on the stats above, we can do 75Mb in 45 seconds, which equates rather neatly to 100Mb / min, which means our 20Gb backups are going to take just over three hours. $60 for a copy of SuperSynchroFlexofile O’Maticalyzer (and I’ll throw in a case of beer if you can come up with a snappier name for the next edition), SSL all the way, and a nice GUI to set it all up.</p>  <p>Isn’t it nice when everything just… <em>works?</em></p>  