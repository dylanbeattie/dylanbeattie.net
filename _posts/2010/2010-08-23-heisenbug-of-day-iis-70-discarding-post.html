---
layout: post
title: 'Heisenbug of the Day: IIS 7.0 Discarding POST Data From Firefox 3 when using
  Custom 404 Handlers'
date: '2010-08-23T13:17:00.001+01:00'
author: Dylan Beattie
tags:
- dotnet
- c#
modified_time: '2017-03-18T15:03:45.194Z'
thumbnail: http://lh6.ggpht.com/_de7B8BtZZIw/THK_THx7txI/AAAAAAAAACE/SoTzmvPtSVw/s72-c/image_thumb%5B2%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-4537565588851174707
blogger_orig_url: http://www.dylanbeattie.net/2010/08/heisenbug-of-day-iis-70-discarding-post.html
redirect_from: "/2010/08/heisenbug-of-day-iis-70-discarding-post.html"

---

<p>Our site uses IIS custom error handlers, so that when you request /not/a/real/page.html, it’ll actually run /errors/404.asp – there’s a <a href="http://www.4guysfromrolla.com/webtech/123000-1.shtml">nice article on 4guysfromrolla</a> about how you do this in classic ASP.</p>  <p>In theory, this works for both GET and POST requests, but last week <a href="http://stackoverflow.com/questions/3510680/firefox-empty-post-with-ajax">we hit a snag</a> – some of our jQuery Ajax code wasn’t working properly in Firefox 3. More specifically – it worked fine locally, it worked fine in all other browsers, but when we deployed the code to any of our test or live servers, it wouldn’t work in Firefox. IE, Opera, Safari, Chrome – all fine; it seems like only Firefox was affected.</p>  <table border="0" cellspacing="0" cellpadding="2" width="499"><tbody>     <tr>       <td valign="top" width="100"><strong>Method</strong></td>        <td valign="top" width="172"><strong>Server</strong></td>        <td valign="top" width="152"><strong>Request URL</strong></td>        <td valign="top" width="73">         <p align="center"><strong>Result</strong></p>       </td>     </tr>      <tr>       <td valign="top" width="100">GET</td>        <td valign="top" width="172">IIS 7.5 (Windows 7)</td>        <td valign="top" width="152">/errors/404.asp</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">POST</td>        <td valign="top" width="172">IIS 7.5 (Windows 7)</td>        <td valign="top" width="152">/errors/404.asp</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">GET</td>        <td valign="top" width="172">IIS 7.5 (Windows 7)</td>        <td valign="top" width="152">(404 handler)</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">POST</td>        <td valign="top" width="172">IIS 7.5 (Windows 7)</td>        <td valign="top" width="152">(404 handler)</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">GET</td>        <td valign="top" width="172">IIS 7.0 (Windows 2008)</td>        <td valign="top" width="152">/errors/404.asp</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">POST</td>        <td valign="top" width="172">IIS 7.0 (Windows 2008)</td>        <td valign="top" width="152">/errors/404.asp</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">GET</td>        <td valign="top" width="172">IIS 7.0 (Windows 2008)</td>        <td valign="top" width="152">(404 handler)</td>        <td valign="top" width="73">         <p align="center"><font color="#00e600"><strong>OK</strong></font></p>       </td>     </tr>      <tr>       <td valign="top" width="100">POST</td>        <td valign="top" width="172">IIS 7.0 (Windows 2008)</td>        <td valign="top" width="152">(404 handler)</td>        <td valign="top" width="73">         <p align="center"><strong><font color="#dd0000">FAIL</font></strong></p>       </td>     </tr>   </tbody></table>  <p>Firebug didn’t show up anything unusual, so we fired up <a href="http://www.fiddler2.com/fiddler2/">Fiddler</a>, a web debugging proxy that’ll show you what’s actually being passed between the client and the server. At least, that’s the idea… what <em>actually</em> happened is that when we started running Fiddler, the bug went away. Yep… we had ourselves a real live Heisenbug:</p>  <blockquote>   <p><strong>Heisenbug: </strong>“…a computer bug that disappears … when an attempt is made to study it.” [via <a href="http://en.wikipedia.org/wiki/Unusual_software_bug#Heisenbug">Wikipedia</a>]</p> </blockquote>  <p>Fiddler runs as an HTTP-level proxy – in other words, it understands the HTTP protocol, and sits between your web browser and your web server, and – in theory – transparently forwards information between them, whilst recording all the bits that fly backwards and forwards so that you can dissect them and see what’s going on. I’d guess that, somehow, Firefox was sending dodgy requests, and Fiddler was cleaning up these requests as part of the proxying process – hence why the problem disappeared when Fiddler was running.</p>  <p>Time to dig a little deeper. <a href="http://www.wireshark.org/">Wireshark</a> is a deep-level network protocol analyser that’ll sniff your network traffic right down to the frame level. What I did next was to load up Wireshark, set up a filter [1] to show only HTTP traffic to/from our build server, and then submit the same request from a couple of different browsers – including Firefox.</p>  <p align="center"><a href="http://lh4.ggpht.com/_de7B8BtZZIw/THK_SoQrU3I/AAAAAAAAACA/p-HxIeSwqNU/s1600-h/image%5B4%5D.png"><img style="border-right-width: 0px; margin: 10px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_de7B8BtZZIw/THK_THx7txI/AAAAAAAAACE/SoTzmvPtSVw/image_thumb%5B2%5D.png?imgmax=800" width="240" height="278" /></a> <a href="http://lh5.ggpht.com/_de7B8BtZZIw/THK_TT1tkMI/AAAAAAAAACI/-aPjsb7xYww/s1600-h/image%5B9%5D.png"><img style="border-right-width: 0px; margin: 10px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_de7B8BtZZIw/THK_T_sUoLI/AAAAAAAAACM/24V8LuKIA7M/image_thumb%5B5%5D.png?imgmax=800" width="240" height="278" /></a> </p>  <p>The first grab there is what’s travelling over the wire when you POST that form using Google Chrome; the second is the same POST submitted using Firefox. Remember – at this point, we’re <em>totally lost</em> and so looking for absolutely anything that’s different. If you look closely, you’ll see the Chrome trace includes an extra line - [Reassembled TCP Segments (680 bytes)] – that isn’t in the Firefox trace. They’re otherwise identical other than known differences like the User-Agent string and so on. Curious. A bit of experimentation verifies that Safari and IE are doing the same thing as Chrome – submitting two frames of data for each POST – where Firefox is only submitting one.</p>  <p>It turns out this triggers a bug in IIS 7.0 when you’re using custom 404 handlers.</p>  <h3>Bad Analogy Time…</h3>  <p><a href="http://lh5.ggpht.com/_de7B8BtZZIw/THK_UuW4T-I/AAAAAAAAACQ/xtVPTb1DjdY/s1600-h/image%5B28%5D.png"><img style="border-bottom: 0px; border-left: 0px; margin: 0px 0px 20px 20px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" align="right" src="http://lh3.ggpht.com/_de7B8BtZZIw/THK_U9wJKNI/AAAAAAAAACU/54MxFCFxugg/image_thumb%5B15%5D.png?imgmax=800" width="136" height="240" /></a> Imagine it’s your birthday. You’ve got a load of packages to open - you open the first one, and there’s a card inside saying “Happy Birthday! Enjoy the Lego! Love Granny xxx” </p>  <p>Now – at this point, you’re expecting some <a href="http://www.flickr.com/groups/1214232@N20/">Lego</a>, right? Well, if Granny is Chrome, IE or Safari, she’s been sensible – she’s sent the card in its own envelope, and put the Lego in the <em>next </em>parcel. But, if Granny is Firefox, then Granny has done something foolish, and has crammed as many of the Lego bricks as she can into the same envelope as the birthday card. If the Lego set is only tiny, then she can fit all the bricks into the envelope – and so won’t bother sending the now-empty Lego box.</p>  <p>So… imagine the envelopes/parcels are TCP frames, the birthday card is your HTTP request, and the Lego is the associated POST data. The card (headers) say “hey, there’s more stuff coming” – and then somewhere close behind, there’s another package with that “stuff” in it.</p>  <p>Now, onto the IIS 7.0 bug. Under normal circumstances, IIS 7 copes just fine with POST data being in the same frame as the actual request. (That’s why this bug doesn’t affect every Firefox user who visits an IIS7 site.) </p>  <p>Thing is - when a request is processed by a custom 404 handler, IIS 7.0 is opening the envelope, finding the birthday card, going “whooopeee! Lego!” – and then throwing the envelope away <em>without checking to see if there’s any Lego in it, </em>before looking around excitedly to see where the next parcel is.</p>  <p>For very small POSTs, this results in the Request.Form being empty (because all the Lego has been thrown away with the envelope). If you deliberately pad your POST with a couple of really long fields - <strong>&lt;input name=”padding” value=”xxxxxxxx … xxx” /&gt;</strong> for 2000 characters or so – then you’ll see that even Firefox now has to split the request over more than one frame, and that any POST values that end up in the second frame are now accessible to IIS via Request.Form in the usual way. Kinda like Granny sending you a really big Lego set, and putting the first 20 or so bricks in the envelope with the birthday card, and the rest in a separate parcel or two – throw away the envelope, and you’ve still got *most* of the bricks, but many of them have gone missing.</p>  <p>So… workarounds. Firefox patch – no good. Too many installed users. Upgrade all our web servers to IIS 7.5? Er, not right now, thanks. IIS hotfix? Lovely – if you’ve got one, send it over.</p>  <p>In the meantime, the best option we could find was to stick two hidden fields at the top of the affected form, something like:</p>  <blockquote>   <p>&lt;input type=”hidden” name=”ff_frame” value=”xxxxx . . . <em>1460 Xs here&#160; . </em>. . xxxx” /&gt;       <br />&lt;input type=”hidden” name=”ff_split” value=”1” /&gt;</p>    <p><font color="#c0c0c0">&lt;!—everything after this point will show up intact in Request.Form --&gt;</font></p>    <p>&lt;input type=”hidden” name=”real” value=”some_data” /&gt;</p> </blockquote>  <p>The big string of X’s pads the first frame to make sure all your real data ends up in the second one, and the ff_split value ensures that this padding doesn’t mess up IIS’ parsing of subsequent POST values. Yes, this is disgusting - and it adds 1Kb+ to every POST - but it’s only required in a handful of places, and we’re looking to isolate it inside the jQuery code we’re using so it’ll be dynamically inserted into POSTs where necessary.</p>  <p><small>[1] ((http.request || http.response) &amp;&amp; (http.host contains &quot;build&quot;)) &amp;&amp; !(http.request.uri == &quot;/favicon.ico&quot;)</small></p>  