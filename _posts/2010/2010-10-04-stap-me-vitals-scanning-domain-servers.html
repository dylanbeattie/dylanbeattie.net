---
layout: post
title: Stap Me Vitals! Scanning Domain Servers using System.Management
date: '2010-10-04T18:00:00.001+01:00'
author: Dylan Beattie
tags: 
modified_time: '2010-10-04T18:00:52.383+01:00'
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-790374958585720907
blogger_orig_url: http://www.dylanbeattie.net/2010/10/stap-me-vitals-scanning-domain-servers.html
---

<p>In preparation for an overhaul of our hosting &amp; network infrastructure, I wanted to gather stats on exactly what was running on all of our remote servers – stuff like how much physical memory is installed in the servers, what’s their Dell service tag, what sort of disk interface they’re running, what version of Windows, that kind of thing.</p>  <p>There’s a command-line tool <a href="http://support.microsoft.com/kb/290216">wmic.exe</a> that does some neat stuff by hooking into the Windows Management Instrumentation interface – little snippets like:</p>  <div id="codeSnippetWrapper">   <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &#39;Consolas&#39;, &#39;Courier New&#39;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><p><strong>C:\&gt;</strong>wmic /node:myserver cpu get description<br />Description<br /></p><p>Intel(R) Xeon(TM) CPU 3.00GHz<br />Intel(R) Xeon(TM) CPU 3.00GHz<br />Intel(R) Xeon(TM) CPU 3.00GHz<br />Intel(R) Xeon(TM) CPU 3.00GHz<br /><br /><br />C:\&gt;</p></pre>

  <br /></div>

<p>- hey, looks like myserver has a quad-core Xeon CPU. Nice. Anyway, doing this across a whole lot of properties on a whole lot of servers would clearly be a bit time-consuming, so here’s how you do it using C# and the System.Management namespaces. The username/password specified in ConnectionOptions will need admin rights on all the servers you’re connecting to, and I’m sure you can reformat the output to look a little nicer, but in a nutshell, this’ll scan all the servers you specify and dump their vitals into D:\servers.txt</p>

<p>Simple - especially once you work out that the documentation for the cryptic magic strings inside the WMI classes is at <a href="http://msdn.microsoft.com/en-us/library/aa394084.aspx">http://msdn.microsoft.com/en-us/library/aa394084.aspx</a></p>

<div id="codeSnippetWrapper">
  <pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: &#39;Consolas&#39;, &#39;Courier New&#39;, courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><p><span style="color: #0000ff">using</span> System;<br /><span style="color: #0000ff">using</span> System.Collections.Generic;<br /><span style="color: #0000ff">using</span> System.IO;<br /><span style="color: #0000ff">using</span> System.Linq;<br /><span style="color: #0000ff">using</span> System.Management;<br /><br /><span style="color: #0000ff">namespace</span> ServerScan {<br />    <span style="color: #0000ff">class</span> Program {<br /><br />        <span style="color: #0000ff">static</span> <span style="color: #0000ff">string</span>[] servers = <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;hugh&quot;</span>, <span style="color: #006080">&quot;pugh&quot;</span>, <span style="color: #006080">&quot;barney&quot;</span>, <span style="color: #006080">&quot;mcgrew&quot;</span>, <span style="color: #006080">&quot;cuthbert&quot;</span>, <span style="color: #006080">&quot;dibble&quot;</span>, <span style="color: #006080">&quot;grubb&quot;</span>};</p><p><font color="#00ff00"> </font><font color="#008000">       // see notes on Win32 instrumentation classes at </font><a href="http://msdn.microsoft.com/en-us/library/aa394084.aspx"><font color="#008000">http://msdn.microsoft.com/en-us/library/aa394084.aspx</font></a><br /><br />        <span style="color: #0000ff">static</span> Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">string</span>[]&gt; wmiClasses = <span style="color: #0000ff">new</span> Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">string</span>[]&gt; {<br />            { <span style="color: #006080">&quot;Win32_DiskDrive&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;Caption&quot;</span>, <span style="color: #006080">&quot;InterfaceType&quot;</span>, <span style="color: #006080">&quot;MediaType&quot;</span>, <span style="color: #006080">&quot;Name&quot;</span>,<span style="color: #006080">&quot;Size&quot;</span> }},<br />            { <span style="color: #006080">&quot;Win32_PhysicalMedia&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;Tag&quot;</span>, <span style="color: #006080">&quot;SerialNumber&quot;</span> }},<br />            { <span style="color: #006080">&quot;Win32_Processor&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;Name&quot;</span>, <span style="color: #006080">&quot;ExtClock&quot;</span>, <span style="color: #006080">&quot;CurrentClockSpeed&quot;</span>, <span style="color: #006080">&quot;DeviceID&quot;</span> }},<br />            { <span style="color: #006080">&quot;Win32_OperatingSystem&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;Name&quot;</span>, <span style="color: #006080">&quot;CSDVersion&quot;</span>, <span style="color: #006080">&quot;Description&quot;</span>, <span style="color: #006080">&quot;TotalVisibleMemorySize&quot;</span> }},<br />            { <span style="color: #006080">&quot;Win32_SCSIController&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;Caption&quot;</span> }},<br />            { <span style="color: #006080">&quot;Win32_SystemEnclosure&quot;</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[] { <span style="color: #006080">&quot;SerialNumber&quot;</span> }}<br />        };<br /><br />        <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> Main(<span style="color: #0000ff">string</span>[] args) {<br />            var output = File.CreateText(<span style="color: #006080">@&quot;D:\servers.csv&quot;</span>);<br />            ConnectionOptions options = <span style="color: #0000ff">new</span> ConnectionOptions();<br />            options.Username = <span style="color: #006080">@&quot;MYDOMAIN\big.boss&quot;</span>;<br />            options.Password = <span style="color: #006080">&quot;password&quot;</span>;<br />            <span style="color: #0000ff">foreach</span> (var server <span style="color: #0000ff">in</span> servers) {<br />                ManagementScope scope = <span style="color: #0000ff">new</span> ManagementScope(String.Format(<span style="color: #006080">@&quot;\\{0}\root\cimv2&quot;</span>, server), options);<br />                <span style="color: #0000ff">try</span> {<br />                    scope.Connect();<br />                    <span style="color: #0000ff">foreach</span> (var wmiClass <span style="color: #0000ff">in</span> wmiClasses.Keys) {<br />                        ObjectQuery query = <span style="color: #0000ff">new</span> ObjectQuery(<span style="color: #006080">&quot;SELECT * FROM &quot;</span> + wmiClass);<br />                        ManagementObjectSearcher searcher = <span style="color: #0000ff">new</span> ManagementObjectSearcher(scope, query);<br />                        Console.WriteLine(<span style="color: #006080">&quot;Searching {0} / {1}&quot;</span>, server, wmiClass);<br />                        var results = searcher.Get();<br />                        <span style="color: #0000ff">foreach</span> (var result <span style="color: #0000ff">in</span> results) {<br />                            <span style="color: #0000ff">foreach</span> (var thing <span style="color: #0000ff">in</span> result.Properties) {<br />                                <span style="color: #0000ff">if</span> (!wmiClasses[wmiClass].Contains(thing.Name)) <span style="color: #0000ff">continue</span>;<br />                                output.Write(String.Format(<span style="color: #006080">&quot;{0}\t{1}\t{2}\t{3}\r\n&quot;</span>, server, wmiClass, thing.Name, thing.Value));<br />                            }<br />                        }<br />                    }<br />                } <span style="color: #0000ff">catch</span> (Exception ex) {<br />                    output.Write(String.Format(<span style="color: #006080">&quot;{0}\tFAIL\tFAIL\t{1}\r\n&quot;</span>, server, ex.Message));<br />                }<br />            }<br />            output.Close();<br />            Console.Write(<span style="color: #006080">&quot;All Done!&quot;</span>);<br />            Console.ReadKey(<span style="color: #0000ff">false</span>);<br />        }<br />    }<br />}<br /></p></pre>

  <br /></div>  