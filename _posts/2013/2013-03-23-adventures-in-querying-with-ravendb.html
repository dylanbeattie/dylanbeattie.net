---
layout: post
title: Adventures in Querying with RavenDB
date: '2013-03-23T17:01:00.001Z'
author: Dylan Beattie
tags: 
modified_time: '2013-03-23T17:01:59.370Z'
thumbnail: http://lh3.ggpht.com/-Tzz8bMqTKSo/UU3f7qszg4I/AAAAAAAAAP4/xmlSXpJx-Tk/s72-c/image_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-7295454224203070190.post-7587940234924574935
blogger_orig_url: http://www.dylanbeattie.net/2013/03/adventures-in-querying-with-ravendb.html
---

<p>For the last couple of months, we've been working on a project that uses <a href="http://ravendb.net/">RavenDB</a> as the main data store. We went with Raven for several reasons - it looked like a pretty good fit for what we were doing, we were using NServiceBus which now includes Raven as its default persistence store, and we were keen to see what it could do. Generally, it's been really, really positive. However, RavenDB is the first document database I've ever used, and so once in a while the learning curve just leaves me scratching my head in frustration...</p>  <p>So, last week, a request comes in for a straightforward one-off report. We're using Raven to store details about media clips - video and audio files - that are linked to our customers' online CVs, and the product owner wanted a list of customers along with the total duration of the media clips linked to those customers' CVs.</p>  <p>In SQL, this would be </p>  <blockquote>   <p>SELECT Customer, SUM(Duration) as TotalDuration FROM MediaClips GROUP BY Customer</p> </blockquote>  <p>The two developers who actually built the system weren't in the office last week, so this request ended up on my desk. &quot;Ah, no problem&quot;, thinks me. After all - it's a database; how hard can it be? I'd spent a bit of time building custom indexes to drive an SLA report we built last week, and with quite a lot of Googling, managed to get some really impressive results out of Raven. </p>  <p>Thing is - I'm not building a feature here, I just need to copy &amp; paste a bunch of numbers into a spreadsheet and get on with my life. And I have no idea how you do that in Raven. I spend an hour or so trying to get Ronnie Overby's <a href="https://github.com/ronnieoverby/RavenDB-Linqpad-Driver">RavenDB provider for LinqPAD to install</a>. This is a third-party library that isn't part of RavenDB, but I like LinqPAD, I'm pretty comfortable with Linq query syntax, and this looked like a good place to start. Half an hour later, after downloading the source, compiling it, creating a certificate, signing it and getting LinqPAD to recognise and install the driver, I gave up because I just couldn't work out how to get any data out of the damn thing. </p>  <p>Instead, I throw together a .NET console app and start playing around with indexes, working from &quot;<a href="http://ravendb.net/docs/2.0/client-api/querying/using-linq-to-query-ravendb">Using Linq to query RavenDB indexes</a>&quot;. I get as far as creating a named map/reduce index that's pulling out the data I need - this takes a good hour or two of trial and error. The eureka moment is when I work out that you can define Raven indexes as raw LINQ code - they're not even embedded strings, they're actually strongly-typed, compiled Linq expressions that are passed in to the query definition. I get as far as this:</p>  <blockquote>   <p><font face="Consolas">class Total {       <br />&#160; public string CustomerId { get; set; }        <br />&#160; public int Duration { get; set; }        <br />}</font></p>    <p><font face="Consolas">public void BuildIndex() {       <br />&#160; var store = new DocumentStore() { ConnectionStringName = &quot;raven&quot; };        <br />&#160; store.Initialize();        <br />&#160; store.DatabaseCommands.PutIndex(&quot;ClipInfos/TotalDurations&quot;, new IndexDefinitionBuilder&lt;ClipInfo, Total&gt; {</font></p>    <p><font face="Consolas">&#160;&#160;&#160; Map = clips =&gt; from clip in clips select new {       <br />&#160;&#160;&#160; Customer = clip.CustomerId,        <br />&#160;&#160;&#160;&#160;&#160; Duration = clip.DurationInSeconds        <br />&#160;&#160;&#160; },</font></p>    <p><font face="Consolas">&#160;&#160;&#160; Reduce = results =&gt; from result in results group result by result.Customer into g select new {       <br />&#160;&#160;&#160;&#160;&#160; Customer = g.Key,        <br />&#160;&#160;&#160;&#160;&#160; Duration = g.Sum(x =&gt; x.Duration)        <br />&#160;&#160;&#160; }        <br />&#160; });        <br />}</font></p> </blockquote>  <p>Now, Raven encourages &quot;safe&quot; query patterns. Which means it'll only give you 128 records per query by default, and if you run more than 30 queries in a single session it'll fail with an exception telling you you're doing something dangerous. The only way I can find to actually retrieve all the data I need is to circumvent these defaults to increase the batch size from 128 to 1024, and then repeated use .Skip(1024*batch).Take(1024) to pull records back 1,024 at a time and add them to my result set.</p>  <blockquote>   <p><font face="Consolas">using (var session = raven.OpenSession()) {       <br />&#160; session.Advanced.MaxNumberOfRequestsPerSession = 512;        <br />&#160; while (true) {        <br />&#160;&#160;&#160; var totals = session.Query&lt;Total&gt;(&quot;ClipInfos/TotalDurations&quot;).Skip(1024 * batches).Take(1024).ToList();         <br />&#160;&#160;&#160; foreach (var total in totals)&#160; {         <br />&#160;&#160;&#160;&#160;&#160; // Do something useful.         <br />&#160;&#160;&#160; }         <br />&#160;&#160;&#160; if (totals.Count() &lt; 1024) break;        <br />&#160;&#160;&#160; batches++;        <br />&#160; }        <br />}</font></p> </blockquote>  <p>At this point, I'm thinking one of two things:</p>  <ol>   <li>This is fine. It's an ad-hoc requirement, and if we end up doing this a *lot* I should read up on the <a href="http://ravendb.net/docs/server/bundles/index-replication">index replication bundle</a> - a plug-in that, I gather, will export indexed data into a relational DB for easier querying.</li>    <li>This is completely wrong. It should not take three hours and a dedicated console application to run a simple ad-hoc query against a set of Raven data. I am missing something obvious...</li> </ol>  <p>As somebody who's been writing SQL for nearly 20 years, it's really frustrating to hit a brick wall like this... and it's been a long day, and I'm getting fed up, and I wander over to Twitter to have a bit of a rant and @ayende pops up:</p>  <p><a href="http://lh4.ggpht.com/-iJA22STRzxk/UU3f6uT4BbI/AAAAAAAAAP0/2FxXwWwVqfc/s1600-h/image%25255B3%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/-Tzz8bMqTKSo/UU3f7qszg4I/AAAAAAAAAP4/xmlSXpJx-Tk/image_thumb%25255B1%25255D.png?imgmax=800" width="518" height="617" /></a></p>  <p>Ah. Dynamic Queries. That looks interesting. So I head over to Raven Studio and sure enough, there's a &quot;Dynamic Queries&quot; facility. So I paste in a simple query and hit &quot;Execute&quot;:</p>  <p><a href="http://lh6.ggpht.com/-K2Z1lDTgIo4/UU3f8S3HM4I/AAAAAAAAAQA/13trudD3ff4/s1600-h/image%25255B20%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-5CXj5TBm9j0/UU3f9UMuDwI/AAAAAAAAAQM/az2aslYpW1g/image_thumb%25255B10%25255D.png?imgmax=800" width="891" height="671" /></a></p>  <p>No results? Huh? But there's tens of thousands of documents in there! At this point I give up and go to the pub.</p>  <p>This morning, I go back to it and notice the little &quot;i&quot; icon next to the Query header, and see this...</p>  <p><a href="http://lh5.ggpht.com/-Crp8FRF0o8E/UU3f-ZY2LTI/AAAAAAAAAQU/BXnR_siKMpk/s1600-h/image%25255B12%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-I95FIJbl7A0/UU3f_R9uMKI/AAAAAAAAAQY/F24GpP4j5lM/image_thumb%25255B6%25255D.png?imgmax=800" width="419" height="236" /></a></p>  <p>Ah. I have no idea what Lucene syntax is... but that probably explains why none of my dynamic queries worked.</p>  <p>Raven is really impressive. We've managed to get it to do some very cool things; it's fast, and most of the time it Just Works. And there is an inevitable learning curve associated with adopting a new technology - particularly one that represents a paradigm shift in approach. It's kinda like learning Powershell and treating it as another CLR/.NET language... which is really, really frustrating, until you realize it's not &quot;scriptable .NET&quot;, it's more like command.com on steroids. The shift from relational to document databases is much the same. That said - it would be really, really useful if the dynamic query tool in Raven Studio would distinguish between &quot;I understand that query but could find no matching records&quot; and &quot;I have no idea what you are trying to do&quot; - I have no idea how strict the Lucene query language or parser is, but knowing whether your query is syntactically valid or not would be a big help when you're trying to work out why it didn't return anything.</p>  <p><a href="http://lh6.ggpht.com/-eR482ATG8gU/UU3gATwT08I/AAAAAAAAAQk/Zt-2dYTNnv8/s1600-h/image%25255B24%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/-wyPakOtZt-w/UU3gBDYcnVI/AAAAAAAAAQs/BUYWQH11OoA/image_thumb%25255B12%25255D.png?imgmax=800" width="891" height="671" /></a></p>  